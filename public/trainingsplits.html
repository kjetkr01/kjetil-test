<!DOCTYPE html>
<html>

<head>
   <title>Treningsplaner</title>

   <meta charset="utf-8" />

   <!-- manifest -->

   <link rel="manifest" href="manifest.json">

   <meta name="mobile-web-app-capable" content="yes">
   <meta name="apple-mobile-web-app-capable" content="yes">
   <meta name="application-name" content="Treningsstatistikken">
   <meta name="apple-mobile-web-app-title" content="Treningsstatistikken">
   <meta name="msapplication-starturl" content="/">
   <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=0">

   <link rel="icon" sizes="192x192" type="image/png" href="images/placeholder_logo_icon.png">
   <link rel="apple-touch-icon" sizes="192x192" type="image/png" href="images/placeholder_logo_icon.png">

   <!-- -->

   <!-- splashscreen for ios -->

   <link href="images/splashscreens/iphone5_splash.png"
      media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)"
      rel="apple-touch-startup-image" />
   <link href="images/splashscreens/iphone6_splash.png"
      media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)"
      rel="apple-touch-startup-image" />
   <link href="images/splashscreens/iphoneplus_splash.png"
      media="(device-width: 621px) and (device-height: 1104px) and (-webkit-device-pixel-ratio: 3)"
      rel="apple-touch-startup-image" />
   <link href="images/splashscreens/iphonex_splash.png"
      media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)"
      rel="apple-touch-startup-image" />
   <link href="images/splashscreens/iphonexr_splash.png"
      media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)"
      rel="apple-touch-startup-image" />
   <link href="images/splashscreens/iphonexsmax_splash.png"
      media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)"
      rel="apple-touch-startup-image" />
   <link href="images/splashscreens/ipad_splash.png"
      media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2)"
      rel="apple-touch-startup-image" />
   <link href="images/splashscreens/ipadpro1_splash.png"
      media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2)"
      rel="apple-touch-startup-image" />
   <link href="images/splashscreens/ipadpro3_splash.png"
      media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2)"
      rel="apple-touch-startup-image" />
   <link href="images/splashscreens/ipadpro2_splash.png"
      media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2)"
      rel="apple-touch-startup-image" />

   <!-- -->

   <!-- status bar color -->

   <meta id="themeColor" name="theme-color" content="#357F9B">
   <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

   <!-- -->

   <link rel="stylesheet" href="styles/global/globalVariables.css">
   <link rel="stylesheet" href="styles/global/globalClasses.css">
   <link rel="stylesheet" href="styles/global/global.css">

   <link rel="stylesheet" href="styles/global/themes.css">

   <link rel="stylesheet" href="styles/shared/exploreDefault.css">

   <link rel="stylesheet" href="styles/trainingsplits/board.css">

   <script src="sw.js" type="module"></script>

   <script src="ts_application.js" type="text/javascript"></script>
   <script src="scripts/global/appInfo.js" type="text/javascript"></script>
   <script src="scripts/global/user.js" type="text/javascript"></script>
   <script src="scripts/global/global.js" type="text/javascript"></script>
   <script src="scripts/global/functions.js" type="text/javascript"></script>
   <script src="scripts/leaderboards/leaderboards.js" type="text/javascript"></script>

</head>

<body>

   <script>
      useHTTPS();
      createUserClass();
      changeColorTheme();
   </script>

   <section id="page">

      <div id="c1r1"></div>
      <div id="c2r1"></div>

      <div id="GbackBtn">
         <svg id="backBtn" class="backBtnIcon fadeInLeft animate delaySmall pointer" style="stroke:white;"
            draggable="false" onclick="redirectToExplore();" xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 22.49 39.22">
            <g id="Layer_2" data-name="Layer 2">
               <g id="Layer_1-2" data-name="Layer 1">
                  <polyline class="cls-1" points="21.25 1.24 2.48 20.02 20.45 37.99" />
               </g>
            </g>
         </svg>
      </div>

      <div id="Gtitle">
         <p id="title" class="noselect">
            Treningsplaner
         </p>
      </div>

      <div id="Ginformation">
         <p id="information" class="noselect">
         </p>
      </div>

      <div id="Gline">
         <hr id="line" class="noselect">
      </div>

      <div id="Glist">
         <div id="list" class="noselect">
         </div>
      </div>

   </section>

</body>

<script>
   "use strict";

   let trainingsplits = null, searchFilter = "", prevList = [];
   function TTrainingsplits(aTrainingsplits) {
      const trainingsplits = aTrainingsplits;

      this.getList = function () {
         return trainingsplits;
      }
   }

   if (user) {

      getTrainingsplitsList();

      // gets a list of all public trainingsplits
      async function getTrainingsplitsList() {

         const information = document.getElementById("information");

         if (navigator.onLine) {

            const cached_trainingsplitTxt = sessionStorage.getItem("cached_trainingsplitTxt");

            if (cached_trainingsplitTxt) {
               information.innerHTML = cached_trainingsplitTxt;
            }

            const infoHeader = {};
            const url = `/user/get/trainingsplit/all`;

            const resp = await callServerAPIPost(infoHeader, url);

            if (resp.hasOwnProperty("trainingsplits")) {

               const totalTrainingsplits = resp.trainingsplits.length;

               let trainingsplitTxt = "";

               if (user.getDetail("isadmin") === true) {
                  if (totalTrainingsplits < 0) {
                     trainingsplitTxt = `${application.name} har ingen treningsplaner.`;
                  } else if (totalTrainingsplits === 1) {
                     trainingsplitTxt = `${application.name} har 1 treningsplan.`;
                  } else {
                     trainingsplitTxt = `
                  ${application.name} har ${totalTrainingsplits} treningsplaner.
                  <br>
                  Du kan trykke deg inn på treningsplanen sitt navn for å se hele planen.`;
                  }
               } else {
                  if (totalTrainingsplits < 0) {
                     trainingsplitTxt = `${application.name} har ingen offentlige treningsplaner.`;
                  } else if (totalTrainingsplits === 1) {
                     trainingsplitTxt = `${application.name} har 1 offentlig treningsplan.`;
                  } else {
                     trainingsplitTxt = `
                  ${application.name} har ${totalTrainingsplits} offentlige treningsplaner.
                  <br>
                  Du kan trykke deg inn på treningsplanen sitt navn for å se hele planen.`;
                  }
               }

               information.innerHTML = trainingsplitTxt;

               sessionStorage.setItem("cached_trainingsplitTxt", trainingsplitTxt);

               if (resp.trainingsplits.length > 5) {
                  information.innerHTML += `<br><br><input id="searchTrainingsplitInp" class="searchInp" placeholder="Søk" onkeyup="checkSearch();"></input>`;
                  const cached_search_trainingsplits = sessionStorage.getItem("cached_search_trainingsplits");
                  if (cached_search_trainingsplits) {
                     const searchDom = document.getElementById("searchTrainingsplitInp");
                     if (searchDom) {
                        searchFilter = cached_search_trainingsplits;
                        searchDom.value = searchFilter;
                        sessionStorage.removeItem("cached_search_trainingsplits");
                     }
                  }
               }

               trainingsplits = new TTrainingsplits(resp.trainingsplits);
               displayAllTrainingsplits();
            }

         } else {
            information.innerHTML = `Du må ha Internett-forbindelse for å hente listen med alle offentlige treningsplaner`;
         }
      }
      // End of getTrainingsplitsList function

   }

   // displays all trainingsplits
   function displayAllTrainingsplits() {

      if (trainingsplits) {
         let trainingsplitsList = trainingsplits.getList();

         trainingsplitsList.sort(function (a, b) { return b.subscriberCount - a.subscriberCount });

         const list = document.getElementById("list");

         let tempList = [];
         if (searchFilter.length > 0) {
            for (let i = 0; i < trainingsplitsList.length; i++) {
               const current = trainingsplitsList[i];
               if (!current.trainingsplit_name.toLowerCase().includes(searchFilter.toLowerCase()) && !current.owner_username.toLowerCase().includes(searchFilter.toLowerCase())) {
               } else {
                  tempList.push(current);
               }
            }
         } else {
            tempList = trainingsplitsList;
         }

         if (JSON.stringify(tempList) !== JSON.stringify(prevList)) {
            prevList = tempList;
            list.innerHTML = "";

            if (tempList.length > 0) {
               for (let i = 0; i < tempList.length; i++) {
                  const current = tempList[i];

                  let placementHTML = `${i + 1}.`, svgMedal = null, svgMedalColor = null;

                  let firstAvailableDay = null;
                  if (current.trainingdays.length > 0) {
                     firstAvailableDay = current.trainingdays[0];
                  }

                  let extraInfoTxt = "";
                  if (current.public === false) {
                     extraInfoTxt = "(<div style='display:inline-block;color:red;'>Privat</div>)";
                  }

                  let trainingsplitNameHTML = `<button class="peopleListTrainingsplitName pointer" onClick="saveSearch();redirectToTrainingsplit('${current.trainingsplit_id}', '${firstAvailableDay}');">${current.trainingsplit_name} ${extraInfoTxt}</button>`;
                  let usernameHTML = `<button class="peopleListName pointer" onClick="saveSearch();redirectToUser('${current.owner_id}');">${current.owner_username}</button>`;

                  if (current.owner_id === user.getId()) {
                     usernameHTML = `<button class="accountOwner pointer" onClick="saveSearch();redirectToUser('${current.owner_id}');">${current.owner_username}</button>`;
                  }

                  switch (i) {
                     case 0:
                        svgMedalColor = "medalIconGold";
                        break;
                     case 1:
                        svgMedalColor = "medalIconSilver";
                        break;
                     case 2:
                        svgMedalColor = "medalIconBronze";
                        break;
                  }

                  if (svgMedal === null && svgMedalColor !== null) {
                     placementHTML = `
            <svg id="placement" class="medals ${svgMedalColor}" draggable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40">
                  <defs>
                     </defs>
                     <g id="Layer_2" data-name="Layer 2">
                     <g id="Layer_1-2" data-name="Layer 1">
                     <path class="${svgMedalColor}"
                     d="M28.33,17.38v-14H11.67V17.38a1.66,1.66,0,0,0,.81,1.44l7,4.18L17.8,26.9l-5.68.48,4.31,3.74-1.31,5.55,4.88-3,4.88,3-1.3-5.55,4.32-3.74-5.68-.48L20.57,23l7-4.18A1.66,1.66,0,0,0,28.33,17.38Zm-6.66,3-1.67,1-1.67-1V5h3.34Z" />
                  </g>
            </g>
         </svg>
         `;
                  }

                  let trainingdaysTxt = "";

                  if (current.trainingdays.length > 0) {
                     trainingdaysTxt = "";
                     const NorweiganDays = {
                        "monday": "Mandag",
                        "tuesday": "Tirsdag",
                        "wednesday": "Onsdag",
                        "thursday": "Torsdag",
                        "friday": "Fredag",
                        "saturday": "Lørdag",
                        "sunday": "Søndag",
                     }

                     /*const NorweiganDays = {
                         "monday": "Man",
                         "tuesday": "Tir",
                         "wednesday": "Ons",
                         "thursday": "Tor",
                         "friday": "Fre",
                         "saturday": "Lør",
                         "sunday": "Søn",
                     }*/
                     for (let j = 0; j < current.trainingdays.length; j++) {
                        const day = NorweiganDays[current.trainingdays[j]];

                        if (j < (current.trainingdays.length - 2)) {
                           trainingdaysTxt += `${day}, `;
                        } else if (j < (current.trainingdays.length - 1)) {
                           trainingdaysTxt += `${day} og `;
                        } else {
                           trainingdaysTxt += day;
                        }
                     }
                  }

                  let subscriberCountTxt = "Ingen abonnenter";

                  if (current.subscriberCount > 0) {
                     subscriberCountTxt = `Abonnenter: ${current.subscriberCount}`;
                  }

                  list.innerHTML += `
         <div class="trainingsplit fadeInUp animate">
         <div id="Gplacement">
         <div id="placement">
            ${placementHTML}
         </div>
         </div>
         <div id="GtrainingsplitName">
         <div id="trainingsplitName">
            ${trainingsplitNameHTML}
         </div>
         </div>
         <div id="GtrainingsplitOwner">
         <div id="trainingsplitOwner">
            Av: ${usernameHTML}
         </div>
         </div>
         <div id="GtotalTrainingdays">
         <div id="totalTrainingdays">
            ${trainingdaysTxt}
         </div>
         </div>
         <div id="GtrainingsplitSubscriberCount">
         <div id="trainingsplitSubscriberCount">
            ${subscriberCountTxt}
         </div>
         </div>

         </div>
         <hr class="boardLine fadeIn animate delayMedium">
         `;

               }
               scrollToSavedPos();
            } else {
               list.innerHTML = `<div class="noResults">Fant ingen resultater</div>`;
            }
         }
      }
   }
   // End of displayAllTrainingsplits function

   // checks search
   function checkSearch() {
      const searchTrainingsplitInp = document.getElementById("searchTrainingsplitInp").value;
      if (searchFilter !== searchTrainingsplitInp) {
         searchFilter = searchTrainingsplitInp;
         displayAllTrainingsplits();
      }
   }
   // End of checkSearch function

   // Eventlistener to save current scroll
   document.getElementById("Glist").addEventListener("scroll", function (e) {
      const scrollY = document.getElementById("Glist").scrollTop;
      sessionStorage.setItem("@scroll-Trainingsplits", scrollY);
   });
   // End of eventlistener

   // scrolls to saved pos if saved
   function scrollToSavedPos() {
      const scrollY = sessionStorage.getItem("@scroll-Trainingsplits");
      if (scrollY) {
         document.getElementById("Glist").scrollTop = scrollY;
      }
   }
   // End of scrollToSavedPos function

   // Saves search
   function saveSearch() {
      const searchTrainingsplit = document.getElementById("searchTrainingsplitInp");
      if (searchTrainingsplit) {
         if (searchTrainingsplit.value.length > 0) {
            sessionStorage.setItem("cached_search_trainingsplits", searchTrainingsplit.value);
         }
      }
   }
   // End of saveSearch function

</script>

</html>