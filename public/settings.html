<!DOCTYPE html>
<html>

<head>
   <title>Innstillinger</title>

   <meta charset="utf-8" />

   <!-- manifest -->

   <link rel="manifest" href="manifest.json">

   <meta name="mobile-web-app-capable" content="yes">
   <meta name="apple-mobile-web-app-capable" content="yes">
   <meta name="application-name" content="Treningsstatistikken">
   <meta name="apple-mobile-web-app-title" content="Treningsstatistikken">
   <meta name="msapplication-starturl" content="/">
   <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=0">

   <link rel="icon" type="image/png" sizes="192x192" href="images/appIcon.png">
   <link rel="apple-touch-icon" type="image/png" sizes="192x192" href="images/appIcon.png">

   <!-- -->

   <!-- status bar color -->

   <meta id="themeColor" name="theme-color" content="#357F9B">
   <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

   <!-- -->

   <link rel="stylesheet" href="styles/global/globalVariables.css">
   <link rel="stylesheet" href="styles/global/globalClasses.css">
   <link rel="stylesheet" href="styles/global/global.css">

   <!-- themeStyleCSS -->
   <link id="themeStyleCSS-default" rel="stylesheet" href="styles/themes/default.css">
   <link id="themeStyleCSS-blue" rel="stylesheet" href="styles/themes/blue.css">
   <!-- themeStyleCSS -->

   <link rel="stylesheet" href="styles/themes/globalThemeValues.css">


   <link rel="stylesheet" href="styles/settings/desktop.css">
   <link rel="stylesheet" href="styles/settings/mobile.css">
   <link rel="stylesheet" href="styles/settings/common.css">

   <link rel="stylesheet" href="styles/settings/settingsGrid.css">
   <!--<link rel="stylesheet" href="styles/index/progressbar.css">-->


   <script src="scripts/global.js" type="text/javascript"></script>
   <script src="scripts/index/script.js" type="text/javascript"></script>

</head>

<body>

   <section id="page">

      <div id="c1r1"></div>
      <div id="c2r1"></div>

      <div id="GbackBtn">
         <svg id="backBtn" class="icons iconsDefaultColor fadeInLeft animate delaySmall" draggable="false"
            onclick="backToPrevious();" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 22.49 39.22">
            <g id="Layer_2" data-name="Layer 2">
               <g id="Layer_1-2" data-name="Layer 1">
                  <polyline class="cls-1" points="21.25 1.24 2.48 20.02 20.45 37.99" />
               </g>
            </g>
         </svg>
      </div>

      <div id="Gtitle">
         <p id="title" class="noselect">
         </p>
      </div>

      <div id="GsettingsGrid">
         <p id="settingsGrid" class="noselect">
         </p>
      </div>

   </section>

</body>

<script>

   changeColorTheme();

   const titleDom = document.getElementById("title");
   const settingsGrid = document.getElementById("settingsGrid");
   let userInfo = null;
   let settings = null;

   function backToPrevious() {

      if (titleDom.innerHTML === "Innstillinger") {
         sessionStorage.removeItem("currentSetting");
         redirectToAccount();
      } else {
         loadSetting("Innstillinger");
      }

   }

   function loadSetting(aSetting) {

      const setting = aSetting;
      if (setting) {
         console.log(setting)
         titleDom.innerHTML = setting;
         settingsGrid.innerHTML = "";
         switch (setting) {
            case "Passord":
               cacheCurrentSetting(setting);
               loadPasswordPage();
               break;
            case "Om deg":
               cacheCurrentSetting(setting);
               loadAboutMePage();
               break;
            case "Utseende":
               cacheCurrentSetting(setting);
               loadAppearancePage();
               break;
            case "Fremgangs info":
               cacheCurrentSetting(setting);
               loadProgressionInfoPage();
               break;
            case "Om appen":
               cacheCurrentSetting(setting);
               loadAboutAppPage();
               break;
            case "pendingUsers":
               cacheCurrentSetting(setting);
               loadPendingUsersPage();
               break;
            default:
               cacheCurrentSetting(setting);
               loadDefaultPage();
               break;
         }
      }
   }

   updateUserInfo();
   async function updateUserInfo() {

      const resp = await getAccountDetails(userID);

      if (resp.hasOwnProperty("info")) {

         userInfo = resp.info;
         settings = resp.info.settings;

         const currentSetting = sessionStorage.getItem("currentSetting") || "Innstillinger";

         loadSetting(currentSetting);

      } else {
         redirectToAccount();
      }
   }

   function cacheCurrentSetting(aCurrentSetting) {

      if (!aCurrentSetting) {
         aCurrentSetting = "Innstillinger";
      }

      const currentSetting = aCurrentSetting;

      sessionStorage.setItem("currentSetting", currentSetting);

   }

   async function loadDefaultPage() {

      titleDom.innerHTML = "Innstillinger";
      settingsGrid.innerHTML = "";

      settingsGrid.innerHTML += getTemplate("Displayname", "displaynameDiv", `<input style="text-align:right;" class='settingsInput' value='${userInfo.displayname}'></input>`, "borderTop");
      settingsGrid.innerHTML += getTemplate("Brukernavn", "usernameDiv", `<input style="text-align:right;" class='settingsInput' value='${userInfo.username}'></input>`);

      settingsGrid.innerHTML += getTemplateWithBtn("Passord", "passwordDiv");

      settingsGrid.innerHTML += getTemplateWithBtn("Om deg", "aboutDiv", "spacingTop");

      if (settings.publicProfile.value === true) {
         settingsGrid.innerHTML += getTemplateWithCheckbox("Privat profil", "profileVisibilityDiv", true, "spacingTop");
      } else {
         settingsGrid.innerHTML += getTemplateWithCheckbox("Privat profil", "profileVisibilityDiv", false, "spacingTop");
      }

      if (settings.displayLeaderboards.value === true) {
         settingsGrid.innerHTML += getTemplateWithCheckbox("Ledertavler synlighet", "leaderboardsVisibilityDiv", true);
      } else {
         settingsGrid.innerHTML += getTemplateWithCheckbox("Ledertavler synlighet", "leaderboardsVisibilityDiv", false);
      }

      if (settings.displayWorkoutList.value === true) {
         settingsGrid.innerHTML += getTemplateWithCheckbox("Trener i dag listen synlighet", "workoutTodayListDiv", true);
      } else {
         settingsGrid.innerHTML += getTemplateWithCheckbox("Trener i dag listen synlighet", "workoutTodayListDiv", false);
      }


      settingsGrid.innerHTML += getTemplateWithBtn("Utseende", "appearanceDiv", "spacingTop");
      settingsGrid.innerHTML += getTemplateWithBtn("Fremgangs info", "appearanceDiv");

      settingsGrid.innerHTML += getTemplateWithBtn("Om appen", "aboutAppDiv", "spacingTop");

      if (userInfo.hasOwnProperty("isadmin")) {
         if (userInfo.isadmin === true) {

            settingsGrid.innerHTML += getPendingRequestsTemplate();

         }
      }

      if (userInfo.hasOwnProperty("apikey")) {
         settingsGrid.innerHTML += getTemplateWithBtn("API", "apiDiv");
      }

      settingsGrid.innerHTML += getLogoutBtn();

      if (userInfo.hasOwnProperty("isadmin")) {
         if (userInfo.isadmin === true) {

            const body = { "authToken": token, "userInfo": user, "onlyNumbers": true };
            const url = `/users/list/pending`;

            const resp = await callServerAPI(body, url);

            if (resp) {
               if (resp.length > 0) {
                  const pendingRequestsTxt = document.getElementsByName("pendingRequestsTxt");
                  pendingRequestsTxt[0].innerHTML = `Forespørsler (${resp.length})`;
               }
            }
         }
      }
   }

   function loadPasswordPage() {

      settingsGrid.innerHTML = justTextTemplate("Her kan du endre passordet ditt her", "left");

      settingsGrid.innerHTML += getCenteredTextTemplate("Skriv inn eksisterende passord", "", "borderTop");
      settingsGrid.innerHTML += getCenteredTextTemplate("<input class='settingsInput' id='exsistingPsw' type='password' placeholder='Fyll inn'></input>");

      settingsGrid.innerHTML += getCenteredTextTemplate("Skriv inn ditt nye ønskede passord", "usernameDiv", "spacingTop");
      settingsGrid.innerHTML += getCenteredTextTemplate("<input class='settingsInput' id='newPsw' type='password' placeholder='Fyll inn'></input>");

      settingsGrid.innerHTML += getCenteredTextTemplate("Gjenta ditt nye ønskede passord", "usernameDiv", "spacingTop");
      settingsGrid.innerHTML += getCenteredTextTemplate("<input class='settingsInput' id='repeatNewPsw' type='password' placeholder='Fyll inn'></input>");

      settingsGrid.innerHTML += getCenteredTextTemplate(`<button class='settingsButton' onClick="alert('savepsw');">Oppdater passord</button>`, "test", "spacingTop");

   }

   function loadAboutMePage() {

      settingsGrid.innerHTML = justTextTemplate("Her kan du velge høyde, vekt og alder. Om profilen din er offentlig, vises dette til andre", "left");

      settingsGrid.innerHTML += getTemplate("Treningssenter", "gymInp", `<input style="text-align:right;" class='settingsInput' value='${userInfo.info.gym}'></input>`, "borderTop");
      settingsGrid.innerHTML += getTemplate("Alder", "ageInp", `<input style="text-align:right;" class='settingsInput' value='${userInfo.info.age}'>år</input>`);

      settingsGrid.innerHTML += getTemplate("Høyde", "heightInp", `<input style="text-align:right;" class='settingsInput' value='${userInfo.info.height}'>cm</input>`, "spacingTop");
      settingsGrid.innerHTML += getTemplate("Vekt", "weightInp", `<input style="text-align:right;" class='settingsInput' value='${userInfo.info.weight}'>kg</input>`);

      settingsGrid.innerHTML += justTextTemplate(`Om du ikke ønsker å velge vekt eller høyde, kan du bruke standard verdier.`, "left");

      settingsGrid.innerHTML += getCenteredTextTemplate(`<button class='settingsButton' onClick="alert('defaultVals');">Standard verdier</button>`, "test1", "borderTop");
   }

   function loadAppearancePage() {

      settingsGrid.innerHTML = justTextTemplate("Her kan du endre utseende på appen!", "left");

      const appearanceThemeHTML = `
      <select id="appearanceThemeSelection">
         <option value="1">Automatisk</option>
  </select>
      `;

      settingsGrid.innerHTML += getTemplate("Tema", "appearanceThemeInp", appearanceThemeHTML, "borderTop");

      const themeKeys = Object.keys(allowedThemes);
      let themeColorOptionsHTML = "";
      let colorTheme = allowedThemes[0].theme;
      const preferredTheme = sessionStorage.getItem("colorTheme") || colorTheme;
      for (let i = 0; i < themeKeys.length; i++) {

         if (preferredTheme === allowedThemes[themeKeys[i]].theme) {
            themeColorOptionsHTML += `<option selected="selected" value="${themeKeys[i]}">${allowedThemes[themeKeys[i]].name}</option>`;
         } else {
            themeColorOptionsHTML += `<option value="${themeKeys[i]}">${allowedThemes[themeKeys[i]].name}</option>`;
         }
      }

      const themeColorSelectionHTML = `
      <select id="themeColorSelection">
    ${themeColorOptionsHTML}
  </select>
      `;

      settingsGrid.innerHTML += getTemplate("Farge-tema", "themeColorInp", themeColorSelectionHTML);

   }

   function loadProgressionInfoPage() {

      settingsGrid.innerHTML = justTextTemplate("Her kan du endre hvor mye informasjon du ønsker å se på startsiden!", "left");

      const badeSizeHTML = `
      <select id="badgeSizeSelection">
         <option value="1">Stor</option>
         <option value="2">Liten</option>
  </select>
      `;

      settingsGrid.innerHTML += getTemplate("Størrelse", "badgeSizeInp", badeSizeHTML, "borderTop");

      const badeInfoHTML = `
      <select id="badeInfoSelection">
         <option value="1">Alt</option>
         <option value="2">KG igjen</option>
         <option value="3">% fremgang</option>
  </select>
      `;

      settingsGrid.innerHTML += getTemplate("Informasjon", "badeInfoInp", badeInfoHTML);

   }

   function loadAboutAppPage() {

      const imageHTML = `
      <img id="logo" src="images/appIcon.png" alt="image" draggable="false" class="noselect settingsLogo"></img>
      `;

      settingsGrid.innerHTML = justTextTemplate(imageHTML, "center");

      const appInfoHTML = `
      <strong>${applicationName}</strong>
      <br>
      <p class="settingsApplicationFullVersion">${applicationFullVersion}</p>
      `;

      settingsGrid.innerHTML += justTextTemplate(appInfoHTML, "center");

      const html = `
      ${applicationName} er et app prosjekt utviklet av <button class="settingsButtonHighlightUser" onClick="viewUser('3');">Kjetil Kristiansen</button>.
      
      <br><br>
      Hjelp til design:
      <button class="settingsButtonHighlightUser" onClick="viewUser('2');">Christoffer Simonsen</button>,
      Christian Jenssen,
      Mandius Abelsen,
      <button class="settingsButtonHighlightUser" onClick="viewUser('41');">Szilard Andri Reynisson</button>,
      Sondre Olsen.
      `;

      settingsGrid.innerHTML += getCenteredTextTemplate(html, "infoAboutApp", "spacingTop");
   }

   async function loadPendingUsersPage() {

      titleDom.innerHTML = "Forespørsler";

      const body = { "authToken": token, "userInfo": user };
      const url = `/users/list/pending`;

      const resp = await callServerAPI(body, url);

      const totalRequests = resp.length;
      let HTMLText = `Det er totalt ${totalRequests} forespørseler<br>Godta eller avlså brukeren`;

      settingsGrid.innerHTML = justTextTemplate(HTMLText, "left");

      const defaultHTML = `
      <p class="settingsPendingUserFullName">Visningsnavn</p>
      <p class="settingsPendingUsername">Brukernavn</p>
      `;

      settingsGrid.innerHTML += getCenteredTextTemplate(defaultHTML, "infoAboutApp", "borderTop");

      const pendingUserKeys = Object.keys(resp);

      for (let i = 0; i < pendingUserKeys.length; i++) {

         const pendingTemplateHTML = `
         <p class="settingsPendingUserFullName">${resp[pendingUserKeys[i]].displayname}</p>
         <p class="settingsPendingUsername">${resp[pendingUserKeys[i]].username}</p>
         <button class="settingsAcceptPendingUser">Godta</button><button class="settingsDeclinePendingUser">Avslå</button>
         `;

         settingsGrid.innerHTML += getCenteredTextTemplate(pendingTemplateHTML, "infoAboutApp", "spacingTop");

      }

   }


   function getTemplate(aSetting, aDivId, aInfo, aSpacingTop) {

      const setting = aSetting || "Innstillingen finnes ikke!";
      const divId = aDivId || "";
      const info = aInfo || "";
      const spacingTop = aSpacingTop || "";
      let borderT = "";

      if (spacingTop) {
         borderT = "borderT";
      }

      const html =
         `
   <div id="${divId}" class="userSettingsDefault noselect ${spacingTop}">
            <div id="cS1" class="${borderT}">
            </div>
            <div id="gsSetting">
               <p id="sSetting">
                  ${setting}
               </p>
            </div>
            <div id="gsInfo">
               <p id="sInfo">
                  ${info}
               </p>
            </div>
            <div id="cS4" class="borderB">
            </div>
         </div>
   `;
      return html;
   }

   function getTemplateWithBtn(aSetting, aDivId, aSpacingTop) {

      const setting = aSetting || "Innstillingen finnes ikke!";
      const divId = aDivId || "";
      const spacingTop = aSpacingTop || "";
      let borderT = "";

      if (spacingTop) {
         borderT = "borderT";
      }

      const html =
         `
         <div id="${divId}" class="userSettingsDefault noselect ${spacingTop}">
            <div id="cS1" class="${borderT}">
            </div>
            <div id="gsSetting">
               <p id="sSetting">
                  ${setting}
               </p>
            </div>
            <div id="gsInfo">
               <svg id="sInfo" class="settingsIcons fadeIn" draggable="false" onclick="loadSetting('${setting}');"
                  xmlns="http://www.w3.org/2000/svg" viewBox="0 0 22.49 39.22">
                  <g id="Layer_2" data-name="Layer 2">
                     <g id="Layer_1-2" data-name="Layer 1">
                        <polyline class="cls-1" points="1.24 1.24 20.02 20.02 2.04 37.99" />
                     </g>
                  </g>
               </svg>
            </div>
            <div id="cS4" class="borderB">
            </div>
         </div>
`;
      return html;
   }



   function getTemplateWithCheckbox(aSetting, aDivId, aChecked, aSpacingTop) {

      const setting = aSetting || "Innstillingen finnes ikke!";
      const divId = aDivId || "";
      const isChecked = aChecked || false;
      const spacingTop = aSpacingTop || "";
      let borderT = "";

      if (spacingTop) {
         borderT = "borderT";
      }

      let html =
         `
         <div id="${divId}" class="userSettingsDefault noselect ${spacingTop}">
            <div id="cS1" class="${borderT}">
            </div>
            <div id="gsSetting">
               <p id="sSetting">
                  ${setting}
               </p>
            </div>
            <div id="gsInfo">
               <label id="sInfo" class="settingsCheckbox fadeIn">
                  <input type="checkbox">
                  <span class="slider round"></span>
               </label>
            </div>
            <div id="cS4" class="borderB">
            </div>
         </div>
`;

      if (isChecked === true) {
         html =
            `
         <div id="${divId}" class="userSettingsDefault noselect ${spacingTop}">
            <div id="cS1" class="${borderT}">
            </div>
            <div id="gsSetting">
               <p id="sSetting">
                  ${setting}
               </p>
            </div>
            <div id="gsInfo">
               <label id="sInfo" class="settingsCheckbox fadeIn">
                  <input type="checkbox" checked>
                  <span class="slider round"></span>
               </label>
            </div>
            <div id="cS4" class="borderB">
            </div>
         </div>
`;
      }

      return html;
   }

   function getLogoutBtn() {

      const html =
         `
<div class="userSettingsDefault noselect spacingTop" style="margin-bottom:80px;">
      <div id="cS1" class="borderT">
      </div>
      <div id="gsSetting">
         <p id="sSetting" style="color:red;" onClick="confirmLogout();">
            Logg ut
         </p>
      </div>
      <div id="gsInfo">
         <p id="sInfo">
            
         </p>
      </div>
      <div id="cS4" class="borderB">
      </div>
   </div>
`;
      return html;
   }


   function confirmLogout() {

      const logout = confirm("Er du sikker på at du vil logge ut?");

      if (logout === true) {

         localStorage.clear();
         sessionStorage.clear();
         redirectToLogin();

      }
   }


   function getPendingRequestsTemplate() {

      const html =
         `
         <div id="pendingRequestsDiv" class="userSettingsDefault noselect">
            <div id="cS1">
            </div>
            <div id="gsSetting">
               <p id="sSetting" name="pendingRequestsTxt">
                  Forespørsler
               </p>
            </div>
            <div id="gsInfo">
               <svg id="sInfo" class="settingsIcons fadeIn" draggable="false" onclick="loadSetting('pendingUsers');"
                  xmlns="http://www.w3.org/2000/svg" viewBox="0 0 22.49 39.22">
                  <g id="Layer_2" data-name="Layer 2">
                     <g id="Layer_1-2" data-name="Layer 1">
                        <polyline class="cls-1" points="1.24 1.24 20.02 20.02 2.04 37.99" />
                     </g>
                  </g>
               </svg>
            </div>
            <div id="cS4" class="borderB">
            </div>
         </div>
`;
      return html;
   }

   function getCenteredTextTemplate(aDetails, aDivId, aSpacingTop) {

      const details = aDetails || "Det har oppstått et problem";
      const divId = aDivId || "";
      const spacingTop = aSpacingTop || "";
      let borderT = "";

      if (spacingTop) {
         borderT = "borderT";
      }

      const html =
         `
<div id="${divId}" class="userSettingsCenteredItems noselect ${spacingTop}">
      <div id="cSC1" class="${borderT}">
      </div>
      <div id="gsCenteredItems">
         <p id="sCenteredItems">
            ${details}
         </p>
      </div>
      <div id="cSC2" class="borderB">
      </div>
   </div>
`;
      return html;
   }

   function justTextTemplate(aText, aTextAlign) {

      if (aTextAlign !== "left" && aTextAlign !== "center") {
         aTextAlign = "left";
      }

      const text = aText;
      const textAlign = aTextAlign;

      const html =
         `
<div class="userSettingsJustText noselect" style="text-align: ${textAlign};">
      <div id="cSJC1">
      </div>
      <div id="gsJustText">
         <p id="sJustText">
            ${text}
         </p>
      </div>
      <div id="cSJC2">
      </div>
   </div>
`;
      return html;

   }

</script>

</html>