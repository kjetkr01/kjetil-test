<!DOCTYPE html>
<html>

<head>
   <title>Min konto</title>

   <meta charset="utf-8" />

   <!-- manifest -->

   <link rel="manifest" href="manifest.json">

   <meta name="mobile-web-app-capable" content="yes">
   <meta name="apple-mobile-web-app-capable" content="yes">
   <meta name="application-name" content="Treningsstatistikken">
   <meta name="apple-mobile-web-app-title" content="Treningsstatistikken">
   <meta name="msapplication-starturl" content="/">
   <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=0">

   <link rel="icon" type="image/png" sizes="192x192" href="images/appIcon.png">
   <link rel="apple-touch-icon" type="image/png" sizes="192x192" href="images/appIcon.png">

   <!-- -->

   <!-- status bar color -->

   <meta id="themeColor" name="theme-color" content="#357F9B">
   <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

   <!-- -->

   <link rel="stylesheet" href="styles/global/globalVariables.css">
   <link rel="stylesheet" href="styles/global/globalClasses.css">
   <link rel="stylesheet" href="styles/global/global.css">
   <link rel="stylesheet" href="styles/themes/default.css">


   <link rel="stylesheet" href="styles/account/desktop.css">
   <link rel="stylesheet" href="styles/account/mobile.css">
   <link rel="stylesheet" href="styles/account/common.css">

   <link rel="stylesheet" href="styles/badges/badges.css">
   <link rel="stylesheet" href="styles/badges/badgeColors.css">
   <link rel="stylesheet" href="styles/account/userGrid.css">
   <!--<link rel="stylesheet" href="styles/index/progressbar.css">-->


   <script src="scripts/global.js" type="text/javascript"></script>
   <script src="scripts/badges/badges.js" type="text/javascript"></script>

</head>

<body>

   <section id="page">

      <div id="c1r1"></div>
      <div id="c2r1"></div>
      <div id="c3r1"></div>
      <div id="c4r1"></div>

      <div id="c1r2"></div>
      <div id="c2r2"></div>
      <div id="c3r2"></div>
      <div id="c4r2"></div>
      <div id="c5r2"></div>
      <div id="c6r2"></div>

      <div id="Gtitle">
         <p id="title" class="noselect">
            Laster...
         </p>
      </div>

      <div id="Ggym">
         <p id="gym" class="noselect">
            Laster...
         </p>
      </div>

      <div id="Ginfo">
         <table id="info" class="infoTable">
            <tr id="infoList">
               <td>
                  Laster...
               </td>
            </tr>
         </table>
      </div>

      <div id="Gsettings">
         <button id="settings" class="noselect settingsBtn">
            Innstillinger
         </button>
      </div>

      <div id="GuserGrid" class="userGrid noselect">
         <div id="userGrid">

            <div id="Glifts">
               <p id="lifts">
                  Laster...
               </p>
            </div>

            <div id="GlineLifts">
               <hr id="lineLifts">
            </div>

            <div id="GbadgesLifts">
               <table id="badgesLifts">
                  <tr id="badgesLiftsTableRow">
                  </tr>
               </table>
            </div>

         </div>
      </div>

      <div id="Gfeed" class="noselect">
         <img id="feed" onclick="redirectToFeed();" draggable="false" class="icons" src="images/feedIcon.svg"
            alt="Feed">
         </img>
      </div>

      <div id="Gleaderboards" class="noselect">
         <img id="leaderboards" onclick="redirectToLeaderboards();" draggable="false" class="icons"
            src="images/leaderboardsIcon.svg" alt="Leaderboards">
         </img>
      </div>

      <div id="Gaccount" class="noselect">
         <img id="account" onclick="redirectToAccount();" draggable="false" class="icons"
            src="images/accountIconActive.svg" alt="Account">
         </img>
      </div>

   </section>

</body>

<script>

   changeBodyPosition();

   getUserDetails();
   async function getUserDetails() {

      if (token && user) {

         let myUsername = username;

         isUpdatingUserObject = true;

         const body = { "authToken": token, "userInfo": user, "viewingUser": myUsername };
         const url = `/users/details/${myUsername}`;

         const resp = await callServerAPI(body, url);

         if (resp.info && resp.updatedUserObject) {

            if (localStorage.getItem("user")) {
               localStorage.setItem("user", JSON.stringify(resp.updatedUserObject));
            } else {
               sessionStorage.setItem("user", JSON.stringify(resp.updatedUserObject));
            }

            displayInformation(resp.info);
         } else {
            alert("Det har oppstått en feil!");
            redirectToFeed();
         }

      }

   }




   // displayInformation
   function displayInformation(respInfo) {

      if (!respInfo) {
         return;
      }

      const userGrid = document.getElementById("userGrid");
      userGrid.innerHTML = "";

      const info = respInfo;
      const size = 0;

      const displayname = info.displayname;
      const gym = info.info.gym;
      const age = info.info.age;
      const height = info.info.height;
      const weight = info.info.weight;

      const lifts = info.lifts;
      const goals = info.goals;
      const program = info.trainingsplit;

      if (displayname) {
         document.getElementById("title").textContent = displayname;
      } else {
         document.getElementById("title").textContent = "";
      }

      if (gym) {
         document.getElementById("gym").textContent = gym;
      } else {
         document.getElementById("gym").textContent = "";
      }

      let infoString = "";

      if (age) {
         if (age >= 15) {
            infoString += `<td>${age} år</td>`;
         }
      }
      if (height) {
         if (height >= 140) {
            infoString += `<td>${height} cm</td>`;
         }
      }
      if (weight) {
         if (weight >= 40) {
            infoString += `<td>${weight} kg</td>`;
         }
      }

      if (infoString) {
         document.getElementById("infoList").innerHTML = infoString;
      } else {
         document.getElementById("infoList").textContent = "";
      }

      if (lifts) {
         displayLifts();
      }

      if (goals) {
         displayGoals();
      }

      if (program) {
         displayTrainingsplit();
      }


      /// ------------ start of displayLifts --------------- ///

      function displayLifts() {

         if (Object.entries(lifts).length > 0) {

            const keys = Object.keys(lifts);

            if (keys.length > 0) {

               const arr = [];
               let msg = "";

               for (let i = 0; i < keys.length; i++) {

                  const liftKeys = lifts[keys[i]];

                  if (liftKeys.ORM !== "0" && liftKeys.ORM !== 0 && liftKeys.ORM !== "") {

                     const prDateArr = liftKeys.PRdate.split(".");

                     if (prDateArr.length === 3) {

                        if (prDateArr[0] > 0 && prDateArr[0] <= 31 && prDateArr[0].length <= 2 && prDateArr[1] > 0 && prDateArr[1] <= 12 && prDateArr[1].length <= 2 && prDateArr[2].length === 4) {

                           const d = new Date();

                           const prDate = new Date(prDateArr[2], (prDateArr[1] - 1), prDateArr[0]);

                           const daysSinceTime = (d - prDate) / (1000 * 3600 * 24);

                           if (daysSinceTime > 0) {
                              msg = `${parseInt(daysSinceTime)} dager siden`;
                           } else if (daysSinceTime === 0) {
                              msg = `I dag`;
                           }
                        }
                     }

                     arr.push({ "exercise": keys[i], "kg": liftKeys.ORM, "msg": msg, "color": "redBadge" });

                  }
               }

               if (arr.length > 0) {

                  userGrid.innerHTML += `
<div id="Glifts">
<p id="lifts">
Løft (${arr.length})
</p>
</div>

<div id="GlineLifts">
<hr id="lineLifts">
</div>

<div id="GbadgesLifts">
<table id="badgesLifts">
<tr id="badgesLiftsTableRow">
</tr>
</table>
</div>
`;

                  arr.sort(function (a, b) { return b.kg - a.kg });

                  for (let i = 0; i < arr.length; i++) {
                     const badge = getBadgeLift(size, arr[i]);

                     if (badge) {
                        document.getElementById("badgesLiftsTableRow").innerHTML += badge;
                     }
                  }
               }
            }
         } else {
            userGrid.innerHTML += `
<div id="Glifts">
<p id="lifts">
Løft
</p>
</div>

<div id="GlineLifts">
<hr id="lineLifts">
</div>

<div id="GbadgesLifts">
<table id="badgesLifts">
<tr id="badgesLiftsTableRow">
</tr>
</table>
</div>
`;
         }

         const badge = getBadgeLift();

         if (badge) {
            document.getElementById("badgesLiftsTableRow").innerHTML += badge;
         }

      }

      /// ------------ end of displayLifts --------------- ///




      /// ------------ start of displayGoals --------------- ///

      function displayGoals() {

         if (Object.entries(goals).length > 0) {

            const goalKeys = Object.keys(goals);

            const arr = [];
            let kgUntilGoal = 0, msg = "";

            for (let i = 0; i < Object.entries(goals).length; i++) {

               if (goalKeys[i]) {

                  if (goals[goalKeys[i]].goal > 0) {

                     const currentGoalPR = parseFloat(goals[goalKeys[i]].goal);
                     let currentLiftPR = 0;

                     if (lifts[goalKeys[i]]) {
                        currentLiftPR = parseFloat(lifts[goalKeys[i]].ORM);
                     }

                     kgUntilGoal = currentGoalPR - currentLiftPR;

                     if (kgUntilGoal < 0) {
                        msg = "Målet er nådd!";
                     } else {
                        msg = `${kgUntilGoal} kg igjen`;
                     }

                     arr.push({ "exercise": goalKeys[i], "kg": currentGoalPR, "kgLeft": kgUntilGoal, "msg": msg, "color": "blueBadge" });
                  }
               }

            }

            if (arr.length > 0) {

               userGrid.innerHTML += `
<div id="Ggoals">
<p id="goals">
Mål (${arr.length})
</p>
</div>

<div id="GlineGoals">
<hr id="lineGoals">
</div>

<div id="GbadgesGoals">
<table id="badgesGoals">
<tr id="badgesGoalsTableRow">
</tr>
</table>
</div>
`;

               arr.sort(function (a, b) { return a.kgLeft - b.kgLeft });

               for (let i = 0; i < arr.length; i++) {

                  const badge = getBadgeGoals(size, arr[i]);

                  if (badge) {
                     document.getElementById("badgesGoalsTableRow").innerHTML += badge;
                  }
               }
            }
         } else {
            userGrid.innerHTML += `
<div id="Ggoals">
<p id="goals">
Mål
</p>
</div>

<div id="GlineGoals">
<hr id="lineGoals">
</div>

<div id="GbadgesGoals">
<table id="badgesGoals">
<tr id="badgesGoalsTableRow">
</tr>
</table>
</div>
`;
         }

         const badge = getBadgeGoals();

         if (badge) {
            document.getElementById("badgesGoalsTableRow").innerHTML += badge;
         }

      }

      /// ------------ end of displayGoals --------------- ///



      /// ------------ start of displayTrainingsplit --------------- ///

      function displayTrainingsplit() {

         userGrid.innerHTML += `
<div id="Gtrainingsplit">
<p id="trainingsplit">
Treningsplan
</p>
</div>

<div id="GlineTrainingsplit">
<hr id="lineTrainingsplit">
</div>

<div id="GbadgesTrainingsplit">
<table id="badgesTrainingsplit">
<tr id="badgesTrainingsplitTableRow">
</tr>
</table>
</div>
`;

         if (Object.entries(program).length > 0) {

            const keys = Object.keys(program);
            const arr = [];

            if (keys.length > 0) {
               for (let i = 0; i < keys.length; i++) {

                  let programKeys = program[keys[i]];

                  if (programKeys !== "0" && programKeys !== 0 && programKeys !== "") {

                     arr.push({ "day": keys[i], "trainingsplit": programKeys, "color": "yellowBadge" });
                  }
               }

               if (arr.length > 0) {

                  arr.sort(function (a, b) { return a.kgLeft - b.kgLeft });

                  for (let i = 0; i < arr.length; i++) {

                     const badge = getBadgeTrainingsplit(size, arr[i]);

                     if (badge) {
                        document.getElementById("badgesTrainingsplitTableRow").innerHTML += badge;
                     }
                  }
               }
            }
         }

         const badge = getBadgeTrainingsplit();

         if (badge) {
            document.getElementById("badgesTrainingsplitTableRow").innerHTML += badge;
         }

      }

      /// ------------ end of displayTrainingsplit --------------- ///


   }

   // end of displayInformation

   setInterval(() => {
      checkConnection("c6r2");
   }, 5000);

</script>

</html>