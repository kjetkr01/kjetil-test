<!DOCTYPE html>
<html>

<head>
   <title>Min konto</title>

   <meta charset="utf-8" />

   <!-- manifest -->

   <link rel="manifest" href="manifest.json">

   <meta name="mobile-web-app-capable" content="yes">
   <meta name="apple-mobile-web-app-capable" content="yes">
   <meta name="application-name" content="Treningsstatestikk">
   <meta name="apple-mobile-web-app-title" content="Treningsstatestikk">
   <meta name="msapplication-starturl" content="/">
   <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=0">

   <link rel="icon" type="image/png" sizes="192x192" href="images/appIcon.png">
   <link rel="apple-touch-icon" type="image/png" sizes="192x192" href="images/appIcon.png">

   <!-- -->

   <script src="scripts/global.js" type="text/javascript"></script>
   <script src="scripts/validateInfo.js" type="text/javascript"></script>
   <script src="scripts/script.js" type="text/javascript"></script>

</head>

<body>

   <button onClick="redirectToHome();">Tilbake (hjem)</button>

   <div id="displayname"></div>
   <div id="age"></div>
   <div id="height"></div>
   <div id="weight"></div>
   <div id="workoutToday"></div>
   <div id="infoDiv"></div>

   <div id="showTotalLift"></div>

   <div id="buttons"></div>

</body>

<script>

   let info = "";

   let displayname = "";
   let age = "";
   let height = "";
   let weight = "";
   let program = "";
   let lifts = "";
   let goals = "";

   let myUsername = "";

   const infoDiv = document.getElementById("infoDiv");

   if (user) {
      try {
         myUsername = JSON.parse(user);
         myUsername = myUsername.username;
         getUserDetails();
      } catch (err) {
         alert(err);
         redirectToHome();
      }
   } else {
      redirectToHome();
   }

   async function getUserDetails() {

      if (token && user) {

         const body = { "authToken": token, "userInfo": user, "viewingUser": myUsername };
         const url = `/users/details/${myUsername}`;

         const resp = await callServerAPI(body, url);

         if (resp) {
            info = resp;
            displayInformation();
         } else {
            alert("En feil har oppstått");
            redirectToHome();
         }

      }

   }

   function displayInformation() {

      if (!info) {
         return;
      }

      displayname = info.displayname;
      age = info.info.age;
      height = info.info.height
      weight = info.info.weight;
      program = info.trainingsplit;
      lifts = info.lifts;
      goals = info.goals;


      if (displayname) {
         document.getElementById("displayname").innerHTML = displayname;
      }
      if (age) {
         document.getElementById("age").innerHTML = age + " år"
      }
      if (height) {
         document.getElementById("height").innerHTML = height + " cm"
      }
      if (weight) {
         document.getElementById("weight").innerHTML = weight + " kg"
      }
      if (program) {

         let dayTxt = "";
         let usermessage = "";

         const day = new Date().getDay();

         switch (day) {
            case 0:
               dayTxt = "Søndag";
               break;
            case 1:
               dayTxt = "Mandag";
               break;
            case 2:
               dayTxt = "Tirsdag";
               break;
            case 3:
               dayTxt = "Onsdag";
               break;
            case 4:
               dayTxt = "Torsdag";
               break;
            case 5:
               dayTxt = "Fredag";
               break;
            case 6:
               dayTxt = "Lørdag";
               break;
         }

         if (program[dayTxt].length > 0 && program[dayTxt] !== "Fri") {
            usermessage = `Trener i dag: ${program[dayTxt]}.`;
         } else {
            usermessage = `Trener ikke i dag.`;
         }

         document.getElementById("workoutToday").innerHTML = usermessage;

         changeInfoDivContent("lifts")

      }

   }

   function changeInfoDivContent(content) {

      if (content === "lifts" || content === "goal" || content === "plan" || content === "requests" || content === "apikey") {

         document.getElementById("infoDiv").innerHTML = "";
         document.getElementById("showTotalLift").innerHTML = "";

         switch (content) {
            case "lifts":
               displayLifts();
               updateButtons(content);
               break;
            case "goal":
               displayGoals();
               updateButtons(content);
               break;
            case "plan":
               displayProgram();
               updateButtons(content);
               break;
            case "requests":
               displayRequests();
               updateButtons(content);
               break;
            case "apikey":
               displayApiKey();
               updateButtons(content);
               break;
         }

      }

   }

   async function updateButtons(current) {

      if (!current) {
         return;
      }

      // buttons

      document.getElementById("buttons").innerHTML = "";

      if (current === "lifts") {
         document.getElementById("buttons").innerHTML += `<button class="activeColor" onClick="changeInfoDivContent('lifts')">Løft</button>`;
      } else {
         document.getElementById("buttons").innerHTML += `<button onClick="changeInfoDivContent('lifts')">Løft</button>`;
      }

      if (current === "goal") {
         document.getElementById("buttons").innerHTML += `<button class="activeColor" onClick="changeInfoDivContent('goal')">Mål</button>`;
      } else {
         document.getElementById("buttons").innerHTML += `<button onClick="changeInfoDivContent('goal')">Mål</button>`;
      }

      if (current === "plan") {
         document.getElementById("buttons").innerHTML += `<button class="activeColor" onClick="changeInfoDivContent('plan')">Treningsplan</button>`;
      } else {
         document.getElementById("buttons").innerHTML += `<button onClick="changeInfoDivContent('plan')">Treningsplan</button>`;
      }


      document.getElementById("buttons").innerHTML += `<button onClick="redirectToSettings();">Instillinger</button>`;
      document.getElementById("buttons").innerHTML += `<button onClick="logOut()">Logg ut</button>`;


      if (info.isadmin === true && info.isadmin) {

         let btnTxt = "Forespørsler";

         if (token && user) {

            const body = { "authToken": token, "userInfo": user, "onlyNumbers": true };
            const url = `/users/list/pending`;

            const resp = await callServerAPI(body, url);

            if (resp) {
               if (resp[0].id) {
                  btnTxt = `Forespørsler (${resp.length})`;
               }
            }
         }

         if (current === "requests") {
            document.getElementById("buttons").innerHTML += `<button class="activeColor" onClick="changeInfoDivContent('requests')">${btnTxt}</button>`;
         } else {
            document.getElementById("buttons").innerHTML += `<button onClick="changeInfoDivContent('requests')">${btnTxt}</button>`;
         }

      }

      if (info.apikey) {

         let btnTxt = "API Key";

         if (current === "apikey") {
            document.getElementById("buttons").innerHTML += `<button class="activeColor" onClick="changeInfoDivContent('apikey')">${btnTxt}</button>`;
         } else {
            document.getElementById("buttons").innerHTML += `<button onClick="changeInfoDivContent('apikey')">${btnTxt}</button>`;
         }

      }

   }

   function displayLifts() {

      if (Object.entries(lifts).length > 0) {

         let keys = Object.keys(lifts);
         infoDiv.innerHTML = "";

         if (keys.length > 0) {
            infoDiv.innerHTML = "Løft: <br><br>";
            for (let i = 0; i < keys.length; i++) {

               let liftKeys = lifts[keys[i]];

               if (liftKeys.ORM !== "0" && liftKeys.ORM !== 0 && liftKeys.ORM !== "") {

                  let msg = `${keys[i]} : ${liftKeys.ORM} kg<br>`;

                  let prDateArr = liftKeys.PRdate.split(".");

                  if (prDateArr.length === 3) {

                     if (prDateArr[0] > 0 && prDateArr[0] <= 31 && prDateArr[0].length <= 2 && prDateArr[1] > 0 && prDateArr[1] <= 12 && prDateArr[1].length <= 2 && prDateArr[2].length === 4) {

                        const d = new Date();

                        const prDate = new Date(prDateArr[2], (prDateArr[1] - 1), prDateArr[0]);

                        function calcTime() {
                           let daysSinceTime = (d - prDate) / (1000 * 3600 * 24);
                           return parseInt(daysSinceTime);
                        }

                        msg = `${keys[i]} : ${liftKeys.ORM} kg Dato: ${liftKeys.PRdate} Dager siden: ${calcTime()}<br>`;

                     }

                  }

                  infoDiv.innerHTML += msg;
               }
            }

            if (lifts.Benkpress && lifts.Knebøy && lifts.Markløft) {

               let Benkpress = lifts.Benkpress.ORM;
               let Knebøy = lifts.Knebøy.ORM;
               let Markløft = lifts.Markløft.ORM;

               if (Benkpress !== "0" && Benkpress !== 0 && Benkpress !== "") {
                  if (Knebøy !== "0" && Knebøy !== 0 && Knebøy !== "") {
                     if (Markløft !== "0" && Markløft !== 0 && Markløft !== "") {

                        Benkpress = parseFloat(Benkpress);
                        Knebøy = parseFloat(Knebøy);
                        Markløft = parseFloat(Markløft);

                        const totalORM = (Benkpress + Knebøy + Markløft);

                        document.getElementById("showTotalLift").innerHTML = `PR Total: <br> ${totalORM.toFixed(2)} KG | ${(totalORM * 2.2).toFixed(2)} LBS`;

                     }
                  }
               }

            }

            let liftsTestDef = { "Benkpress": { "ORM": "50", "PRdate": "17.12.2020" }, "Knebøy": { "ORM": "75.5", "PRdate": "17.12.2020" }, "Markløft": { "ORM": "121.25", "PRdate": "17.12.2020" } };
         }
      }

   }

   function displayGoals() {

      if (Object.entries(goals).length > 0) {

         let keys = Object.keys(goals);
         infoDiv.innerHTML = "";

         if (keys.length > 0) {
            infoDiv.innerHTML = "Mål: <br><br>";
            for (let i = 0; i < keys.length; i++) {

               let liftKeys = goals[keys[i]];

               if (liftKeys.goal !== "0" && liftKeys.goal !== 0 && liftKeys.goal !== "") {

                  let msg = "";

                  let prDateArr = liftKeys.Goaldate.split(".");

                  if (prDateArr.length === 3) {

                     if (prDateArr[0] > 0 && prDateArr[0] <= 31 && prDateArr[0].length <= 2 && prDateArr[1] > 0 && prDateArr[1] <= 12 && prDateArr[1].length <= 2 && prDateArr[2].length === 4) {

                        const d = new Date();

                        const prDate = new Date(prDateArr[2], (prDateArr[1] - 1), prDateArr[0]);

                        function calcTime() {
                           let daysSinceTime = (d - prDate) / (1000 * 3600 * 24);
                           return parseInt(daysSinceTime);
                        }

                        if (liftKeys.goal && lifts[keys[i]]) {

                           let PRnum = parseFloat(lifts[keys[i]].ORM);
                           let goalnum = parseFloat(liftKeys.goal);

                           if (PRnum < goalnum) {
                              let untilGoalCalcKG = goalnum;

                              if (PRnum !== 0) {
                                 untilGoalCalcKG = goalnum - PRnum;
                              }

                              let untilGoal = `${untilGoalCalcKG} kg`;

                              msg = `${keys[i]} : ${liftKeys.goal} kg Ifra målet: ${untilGoal} Dato: ${liftKeys.Goaldate} Dager siden: ${calcTime()}<br>`;
                           } else {
                              msg = `${keys[i]} : ${liftKeys.goal} kg Dato: ${liftKeys.Goaldate} Dager siden: ${calcTime()}<br>`;
                           }

                        } else {
                           msg = `${keys[i]} : ${liftKeys.goal} kg Dato: ${liftKeys.Goaldate} Dager siden: ${calcTime()}<br>`;
                        }
                     }

                  }

                  infoDiv.innerHTML += msg;
               }
            }

            let goalsTestDef = { "Benkpress": { "goal": "50", "Goaldate": "17.12.2020" }, "Knebøy": { "goal": "75.5", "Goaldate": "17.12.2020" }, "Markløft": { "goal": "121.25", "Goaldate": "17.12.2020" } };
         }
      }

   }

   function displayProgram() {

      if (Object.entries(program).length > 0) {

         let keys = Object.keys(program);
         infoDiv.innerHTML = "";

         if (keys.length > 0) {
            infoDiv.innerHTML = "Treningsplan: <br><br>";
            for (let i = 0; i < keys.length; i++) {

               let liftKeys = program[keys[i]];

               if (liftKeys !== "0" && liftKeys !== 0 && liftKeys !== "") {

                  let msg = `${keys[i]}: ${liftKeys}<br>`;

                  infoDiv.innerHTML += msg;
               }
            }

         }
      }

   }

   async function displayApiKey() {

      if (info.apikey) {

         infoDiv.innerHTML = "";

         infoDiv.innerHTML = "Din API Key er: <br><br>";

         const config = {
            method: "GET",
            headers: {
               "content-type": "application/json"
            }
         }

         infoDiv.innerHTML += `
            <div>${info.apikey}</div>
            <div>Liste med alle APIer:</div>
            `;

         const response = await fetch("/api", config);
         const data = await response.json();

         if (data) {
            for (let i = 0; i < data.length; i++) {
               infoDiv.innerHTML += `
               <div>${data[i]}</div>
               `;
            }
         } else {
            infoDiv.innerHTML += errorLoadingText;
         }



      }

   }

   async function displayRequests() {

      if (token && user) {

         infoDiv.innerHTML = loadingText;

         const body = { "authToken": token, "userInfo": user };
         const url = `/users/list/pending`;

         const resp = await callServerAPI(body, url);

         infoDiv.innerHTML = "Forespørsler: <br><br>";

         if (resp) {

            if (resp[0].username) {

               for (let i = 0; i < resp.length; i++) {
                  infoDiv.innerHTML += `<div>
               Navn:${resp[i].displayname} Brukernavn: ${resp[i].username}
               <button onClick='acceptPendingUser("${resp[i].username}", true)'>Godta</button>
               <button onClick='acceptPendingUser("${resp[i].username}", false)'>Avslå</button>
               </div>`;
               }

               infoDiv.innerHTML += "Det er totalt " + resp.length + " forespørseler (brukere)!";

            } else {
               infoDiv.innerHTML = errorLoadingText;
            }

         } else {
            infoDiv.innerHTML = "Det er ingen forespørseler!";
         }

      }

   }

   // acceptOrDeny users

   async function acceptPendingUser(username, acceptOrDeny) {
      if (!username || acceptOrDeny === "") {
         return;
      }

      let statusMsg = "godta";
      let statusMsg2 = "Du har nå godtatt forespørselen til: ";

      if (!acceptOrDeny) {
         statusMsg = "avslå";
         statusMsg2 = "Du har nå avslått forespørselen til: ";
      }

      const confirmPress = confirm("Er du sikker på at du vil " + statusMsg + " " + username + " sin forespørsel?");
      if (confirmPress === true) {

         const body = { "authToken": token, "userInfo": user, "pendingUser": username, "acceptOrDeny": acceptOrDeny };
         const url = `/users/pending/${username}/${acceptOrDeny}`;

         const results = await callServerAPI(body, url);

         if (results === "Ok") {
            alert(statusMsg2 + username);
         } else {
            alert("Feil, brukeren finnes ikke!");
         }

         displayRequests();
      }
   }

   function logOut() {
      localStorage.clear();
      sessionStorage.clear();
      location.reload();
   }

</script>

</html>