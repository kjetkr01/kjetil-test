<!DOCTYPE html>
<html>

<head>
   <title>Min konto</title>

   <meta charset="utf-8" />

   <!-- manifest -->

   <link rel="manifest" href="manifest.json">

   <meta name="mobile-web-app-capable" content="yes">
   <meta name="apple-mobile-web-app-capable" content="yes">
   <meta name="application-name" content="Treningsstatestikk">
   <meta name="apple-mobile-web-app-title" content="Treningsstatestikk">
   <meta name="msapplication-starturl" content="/">
   <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=0">

   <link rel="icon" type="image/png" sizes="192x192" href="images/appIcon.png">
   <link rel="apple-touch-icon" type="image/png" sizes="192x192" href="images/appIcon.png">

   <!-- -->

   <link rel="stylesheet" href="styles/global.css">
   <link rel="stylesheet" href="styles/account.css">

   <script src="scripts/global.js" type="text/javascript"></script>
   <script src="scripts/validateInfo.js" type="text/javascript"></script>
   <script src="scripts/script.js" type="text/javascript"></script>

   <script src="scripts/displayUserContent.js" type="text/javascript"></script>

</head>

<body>

   <section id="page">

      <!-- spacing items-->

      <div id="e1r1"></div>
      <div id="e2r1"></div>
      <div id="e3r1"></div>
      <div id="e4r1"></div>

      <!-- -->

      <!-- content items-->

      <div id="c1r1"></div>
      <div id="c2r1"></div>

      <div id="c1r2"></div>
      <div id="c2r2"></div>
      <div id="c3r2"></div>
      <div id="c4r2"></div>
      <div id="c5r2"></div>
      <div id="c6r2"></div>

      <div id="c1r3"></div>
      <div id="c2r3"></div>

      <!-- -->

      <!-- element content items-->

      <!-- header -->

      <div id="Glinks">
         <table id="links">

         </table>
      </div>

      <!-- -->

      <!-- content/middle -->

      <div id="displaynameG">
         <p id="displayname">

         </p>
      </div>

      <div id="infoListG">
         <table id="infoList">

         </table>
      </div>

      <div id="listTitleG">
         <p id="listTitle">

         </p>
      </div>

      <div id="listG">
         <table id="list">

         </table>
      </div>

      <div id="showTotalLiftG">
         <p id="showTotalLift">

         </p>
      </div>

      <div id="buttonsG">
         <table id="buttons">

         </table>
      </div>

      <!-- -->

      <!-- footer -->

      <div id="Gfootermenu">
         <p id="footermenu">

         </p>
      </div>

      <!-- -->

   </section>

</body>

<script>

   displayLinks("links");
   checkColorTheme();

   let info = "";

   let displayname = "";
   let age = "";
   let height = "";
   let weight = "";
   let program = "";
   let lifts = "";
   let goals = "";

   let myUsername = "";

   //const infoDiv = document.getElementById("infoDiv");
   const listTitle = document.getElementById("listTitle");
   const list = document.getElementById("list");

   if (user) {
      try {
         myUsername = JSON.parse(user);
         myUsername = myUsername.username;
         getUserDetails();
      } catch (err) {
         alert(err);
         redirectToHome();
      }
   } else {
      redirectToHome();
   }

   async function getUserDetails() {

      if (token && user) {

         const body = { "authToken": token, "userInfo": user, "viewingUser": myUsername };
         const url = `/users/details/${myUsername}`;

         const resp = await callServerAPI(body, url);

         if (resp) {
            info = resp;
            displayInformation();
         } else {
            alert("En feil har oppstått");
            redirectToHome();
         }

      }

   }

   function changelistContent(content) {

      if (content === "lifts" || content === "goal" || content === "plan" || content === "requests" || content === "apikey") {

         list.innerHTML = "";
         document.getElementById("showTotalLift").innerHTML = "";
         sessionStorage.setItem("currentListContent", content);

         switch (content) {
            case "lifts":
               displayLifts();
               updateButtons(content);
               break;
            case "goal":
               displayGoals();
               updateButtons(content);
               break;
            case "plan":
               displayProgram();
               updateButtons(content);
               break;
            case "requests":
               displayRequests();
               updateButtons(content);
               break;
            case "apikey":
               displayApiKey();
               updateButtons(content);
               break;
         }

      } else {
         changelistContent("lifts");
      }

   }

   async function updateButtons(current) {

      if (!current) {
         return;
      }

      // buttons

      const buttons = document.getElementById("buttons");

      let buttonsString = "";

      buttons.innerHTML = "";

      if (current === "lifts") {
         //document.getElementById("buttons").innerHTML += `<button class="activeColor" onClick="changelistContent('lifts')">Løft</button>`;
         buttonsString += `<td><button class="activeColor listButton" onClick="changelistContent('lifts')">Løft</button></td>`;
      } else {
         //document.getElementById("buttons").innerHTML += `<button onClick="changelistContent('lifts')">Løft</button>`;
         buttonsString += `<td><button class="listButton" onClick="changelistContent('lifts')">Løft</button></td>`;
      }

      if (current === "goal") {
         //document.getElementById("buttons").innerHTML += `<button class="activeColor" onClick="changelistContent('goal')">Mål</button>`;
         buttonsString += `<td><button class="activeColor listButton" onClick="changelistContent('goal')">Mål</button></td>`;
      } else {
         //document.getElementById("buttons").innerHTML += `<button onClick="changelistContent('goal')">Mål</button>`;
         buttonsString += `<td><button class="listButton" onClick="changelistContent('goal')">Mål</button></td>`;
      }

      if (current === "plan") {
         //document.getElementById("buttons").innerHTML += `<button class="activeColor" onClick="changelistContent('plan')">Treningsplan</button>`;
         buttonsString += `<td><button class="activeColor listButton" onClick="changelistContent('plan')">Treningsplan</button></td>`;
      } else {
         //document.getElementById("buttons").innerHTML += `<button onClick="changelistContent('plan')">Treningsplan</button>`;
         buttonsString += `<td><button class="listButton" onClick="changelistContent('plan')">Treningsplan</button></td>`;
      }

      buttons.innerHTML = `<tr>${buttonsString}</tr>`;

      //document.getElementById("buttons").innerHTML += `<button onClick="redirectToSettings();">Instillinger</button>`;
      //document.getElementById("buttons").innerHTML += `<button onClick="logOut()">Logg ut</button>`;

      buttonsString = `<td><button class="listButton" onClick="redirectToSettings();">Innstillinger</button></td>`;
      buttonsString += `<td><button class="listButton" onClick="logOut();">Logg ut</button></td>`;

      if (info.apikey) {

         let btnTxt = "API Key";

         if (current === "apikey") {
            //document.getElementById("buttons").innerHTML += `<button class="activeColor" onClick="changelistContent('apikey')">${btnTxt}</button>`;
            buttonsString += `<td><button class="activeColor listButton" onClick="changelistContent('apikey')">${btnTxt}</button></td>`;
         } else {
            //document.getElementById("buttons").innerHTML += `<button onClick="changelistContent('apikey')">${btnTxt}</button>`;
            buttonsString += `<td><button class="listButton" onClick="changelistContent('apikey')">${btnTxt}</button></td>`;
         }

      }

      buttons.innerHTML += `<tr>${buttonsString}</tr>`;

      if (info.isadmin === true && info.isadmin) {

         let btnTxt = "Forespørsler";

         if (token && user) {

            buttons.innerHTML += `<tr><td id="showPendingUsersBtn">${loadingText}</td> <td><button class="listButton" onClick='window.history.back();'>Tilbake</button></td></tr>`;

            const showPendingUsersBtn = document.getElementById("showPendingUsersBtn");

            const body = { "authToken": token, "userInfo": user, "onlyNumbers": true };
            const url = `/users/list/pending`;

            const resp = await callServerAPI(body, url);

            if (resp) {
               if (resp[0].id) {
                  btnTxt = `Forespørsler (${resp.length})`;
               }
            }
         }

         if (current === "requests") {
            //document.getElementById("buttons").innerHTML += `<button class="activeColor" onClick="changelistContent('requests')">${btnTxt}</button>`;
            buttonsString = `<button class="activeColor listButton" onClick="changelistContent('requests')">${btnTxt}</button>`;
         } else {
            //document.getElementById("buttons").innerHTML += `<button onClick="changelistContent('requests')">${btnTxt}</button>`;
            buttonsString = `<button class="listButton" onClick="changelistContent('requests')">${btnTxt}</button>`;
         }

         showPendingUsersBtn.innerHTML = buttonsString;

      } else {
         buttons.innerHTML += `<tr><td></td><td><button class="listButton" onClick='window.history.back();'>Tilbake</button></td><td></td></tr>`;
      }

   }

   async function displayApiKey() {

      if (info.apikey) {

         listTitle.innerHTML = "Din API Key er:<hr>";

         const config = {
            method: "GET",
            headers: {
               "content-type": "application/json"
            }
         }

         list.innerHTML = "<tr>";

         list.innerHTML += `
            <td>${info.apikey}
            <br>
            <br>
            Liste med alle APIer:</td>
            `;

         const response = await fetch("/api", config);
         const data = await response.json();

         if (data) {
            for (let i = 0; i < data.length; i++) {
               list.innerHTML += `
               <td>${data[i]}</td>
               `;
            }

            list.innerHTML += "</tr>";
         } else {
            list.innerHTML += errorLoadingText;
         }



      }

   }

   async function displayRequests() {

      if (token && user) {

         listTitle.innerHTML = loadingText;

         const body = { "authToken": token, "userInfo": user };
         const url = `/users/list/pending`;

         const resp = await callServerAPI(body, url);

         if (resp) {

            if (resp[0].username) {

               listTitle.innerHTML = "Forespørsler:<hr>";

               list.innerHTML.innerHTML = "<tr>";

               for (let i = 0; i < resp.length; i++) {
                  list.innerHTML += `
                  <td>
                  Navn:
                  <br>
                  ${resp[i].displayname}
                  </td>
                  <td>
                  Brukernavn:
                  <br>
                  ${resp[i].username}
                  </td>
                  <td>
                  <button class="listButton" onClick='acceptPendingUser("${resp[i].username}", true)'>Godta</button>
                  <button class="listButton" onClick='acceptPendingUser("${resp[i].username}", false)'>Avslå</button>
                  </td>
                  `;
               }

               list.innerHTML += "</tr>";
               /*
               if (resp.length === 1) {
                  list.innerHTML += "Det er " + resp.length + " forespørsel (bruker)!";
               } else {
                  list.innerHTML += "Det er totalt " + resp.length + " forespørseler (brukere)!";
               }
               */

            } else {
               listTitle.innerHTML = errorLoadingText;
            }

         } else {
            listTitle.innerHTML = "Det er ingen forespørseler!";
         }

      }

   }

   // acceptOrDeny users

   async function acceptPendingUser(username, acceptOrDeny) {
      if (!username || acceptOrDeny === "") {
         return;
      }

      let statusMsg = "godta";
      let statusMsg2 = "Du har nå godtatt forespørselen til: ";

      if (!acceptOrDeny) {
         statusMsg = "avslå";
         statusMsg2 = "Du har nå avslått forespørselen til: ";
      }

      const confirmPress = confirm("Er du sikker på at du vil " + statusMsg + " " + username + " sin forespørsel?");
      if (confirmPress === true) {

         const body = { "authToken": token, "userInfo": user, "pendingUser": username, "acceptOrDeny": acceptOrDeny };
         const url = `/users/pending/${username}/${acceptOrDeny}`;

         const results = await callServerAPI(body, url);

         if (results === "Ok") {
            alert(statusMsg2 + username);
         } else {
            alert("Feil, brukeren finnes ikke!");
         }

         //displayRequests();
         changelistContent("requests");
      }
   }

   function logOut() {
      localStorage.clear();
      sessionStorage.clear();
      location.reload();
   }

</script>

</html>