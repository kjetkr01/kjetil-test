<!DOCTYPE html>
<html>

<head>
    <title>Laster...</title>

    <meta charset="utf-8" />

    <!-- manifest -->

    <link rel="manifest" href="manifest.json">

    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Treningsstatestikk">
    <meta name="apple-mobile-web-app-title" content="Treningsstatestikk">
    <meta name="msapplication-starturl" content="/">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=0">

    <link rel="icon" type="image/png" sizes="192x192" href="images/appIcon.png">
    <link rel="apple-touch-icon" type="image/png" sizes="192x192" href="images/appIcon.png">

    <!-- -->

    <link rel="stylesheet" href="styles/global.css">
    <link rel="stylesheet" href="styles/user.css">

    <script src="scripts/global.js" type="text/javascript"></script>
    <script src="scripts/validateInfo.js" type="text/javascript"></script>
    <script src="scripts/script.js" type="text/javascript"></script>

</head>

<body>

    <section id="page">

        <!-- spacing items-->

        <div id="e1r1"></div>
        <div id="e2r1"></div>
        <div id="e3r1"></div>
        <div id="e4r1"></div>

        <!-- -->

        <!-- content items-->

        <div id="c1r1"></div>
        <div id="c2r1"></div>

        <div id="c1r2"></div>
        <div id="c2r2"></div>
        <div id="c3r2"></div>
        <div id="c4r2"></div>
        <div id="c5r2"></div>
        <div id="c6r2"></div>

        <div id="c1r3"></div>
        <div id="c2r3"></div>

        <!-- -->

        <!-- element content items-->

        <!-- header -->

        <div id="Glinks">
            <table id="links">

            </table>
        </div>

        <!-- -->

        <!-- content/middle -->

        <div id="displaynameG">
            <p id="displayname">

            </p>
        </div>

        <div id="infoListG">
            <table id="infoList">

            </table>
        </div>

        <div id="workoutTodayG">
            <p id="workoutToday">

            </p>
        </div>

        <div id="listTitleG">
            <p id="listTitle">

            </p>
        </div>

        <div id="listG">
            <table id="list">

            </table>
        </div>

        <div id="showTotalLiftG">
            <p id="showTotalLift">

            </p>
        </div>

        <div id="buttonsG">
            <table id="buttons">

            </table>
        </div>

        <div id="backBtnG">
            <p id="backBtn">
                <button class="listButton" onClick='window.history.back();'>Tilbake</button>
            </p>
        </div>

        <!-- -->

        <!-- footer -->

        <div id="Gfootermenu">
            <p id="footermenu">

            </p>
        </div>

        <!-- -->

    </section>

</body>

<script>

    displayLinks("links");
    checkColorTheme();

    let info = "";

    let displayname = "";
    let age = "";
    let height = "";
    let weight = "";
    let program = "";
    let lifts = "";
    let goals = "";

    const viewingUser = sessionStorage.getItem("ViewingUser");
    const listTitleG = document.getElementById("listTitleG");
    const listTitle = document.getElementById("listTitle");
    const list = document.getElementById("list");

    if (viewingUser) {
        document.title = viewingUser + " sin profil";
        getUserDetails()
    } else {
        redirectToUsers();
    }

    async function getUserDetails() {

        if (token && user) {

            const body = { "authToken": token, "userInfo": user, "viewingUser": viewingUser };
            const url = `/users/details/${viewingUser}`;

            const resp = await callServerAPI(body, url);

            if (resp) {

                if (resp.username) {
                    info = resp;
                    displayInformation();

                } else {
                    alert(resp);
                    redirectToUsers();

                }

            } else {
                alert("Brukeren " + viewingUser + " finnes ikke!");
                redirectToUsers();
            }
        }

    }

    function displayInformation() {

        if (!info) {
            return;
        }

        displayname = info.displayname;
        age = info.info.age;
        height = info.info.height
        weight = info.info.weight;
        program = info.trainingsplit;
        lifts = info.lifts;
        goals = info.goals;

        const infoList = document.getElementById("infoList");

        if (displayname) {
            document.getElementById("displayname").innerHTML = displayname;
        }
        /* old version
        if (age) {
            infoList.innerHTML = `
            <tr>
            <td>${age} år</td>
            </tr>
            `;
        }
        if (height) {
            infoList.innerHTML += `
            <tr>
            <td>${height} cm</td>
            </tr>
            `;
        }
        if (weight) {
            infoList.innerHTML += `
            <tr>
            <td>${weight} kg</td>
            </tr>
            `;
        }
        */

        // new version

        let infoString = "";

        if (age) {
            infoString += `<td>${age} år</td>`;
        }
        if (height) {
            infoString += `<td>${height} cm</td>`;
        }
        if (weight) {
            infoString += `<td>${weight} kg</td>`;
        }

        if (infoString) {
            infoList.innerHTML = `<tr>${infoString}</tr>`;
        }

        //

        if (program) {

            let dayTxt = "";
            let usermessage = "";

            const day = new Date().getDay();

            switch (day) {
                case 0:
                    dayTxt = "Søndag";
                    break;
                case 1:
                    dayTxt = "Mandag";
                    break;
                case 2:
                    dayTxt = "Tirsdag";
                    break;
                case 3:
                    dayTxt = "Onsdag";
                    break;
                case 4:
                    dayTxt = "Torsdag";
                    break;
                case 5:
                    dayTxt = "Fredag";
                    break;
                case 6:
                    dayTxt = "Lørdag";
                    break;
            }

            if (program[dayTxt].length > 0 && program[dayTxt] !== "Fri") {
                usermessage = `Trener i dag: ${program[dayTxt]}.`;
            } else {
                usermessage = `Trener ikke i dag.`;
            }

            document.getElementById("workoutToday").innerHTML = usermessage;

            changelistContent("lifts");

        }

    }

    function changelistContent(content) {

        if (content === "lifts" || content === "goal" || content === "plan") {

            list.innerHTML = "";
            document.getElementById("showTotalLift").innerHTML = "";

            switch (content) {
                case "lifts":
                    displayLifts();
                    updateButtons(content);
                    break;
                case "goal":
                    displayGoals();
                    updateButtons(content);
                    break;
                case "plan":
                    displayProgram();
                    updateButtons(content);
                    break;
            }

        }

    }

    function updateButtons(current) {

        if (!current) {
            return;
        }

        // buttons

        const buttons = document.getElementById("buttons");

        let buttonsString = "";

        buttons.innerHTML = "";

        if (Object.entries(lifts).length > 0 && current === "lifts") {
            //buttons.innerHTML += `<button class="activeColor" onClick="changelistContent('lifts')">Løft</button>`;
            buttonsString += `<td><button class="activeColor listButton" onClick="changelistContent('lifts')">Løft</button></td>`;
        } else if (Object.entries(lifts).length > 0) {
            //buttons.innerHTML += `<button onClick="changelistContent('lifts')">Løft</button>`;
            buttonsString += `<td><button class="listButton" onClick="changelistContent('lifts')">Løft</button></td>`;
        }

        if (Object.entries(goals).length > 0 && current === "goal") {
            //buttons.innerHTML += `<button class="activeColor" onClick="changelistContent('goal')">Mål</button>`;
            buttonsString += `<td><button class="activeColor listButton" onClick="changelistContent('goal')">Mål</button></td>`;
        } else if (Object.entries(goals).length > 0) {
            //buttons.innerHTML += `<button onClick="changelistContent('goal')">Mål</button>`;
            buttonsString += `<td><button class="listButton" onClick="changelistContent('goal')">Mål</button></td>`;
        }

        if (Object.entries(program).length > 0) {

            /*let keys = Object.keys(program);

            for (let i = 0; i < Object.entries(program).length; i++) {
                if (program[keys[i]].length > 0) {*/

            if (current === "plan") {
                //buttons.innerHTML += `<button class="activeColor" onClick="changelistContent('plan')">Treningsplan</button>`;
                buttonsString += `<td><button class="activeColor listButton" onClick="changelistContent('plan')">Treningsplan</button></td>`;
            } else {
                //buttons.innerHTML += `<button onClick="changelistContent('plan')">Treningsplan</button>`;
                buttonsString += `<td><button class="listButton" onClick="changelistContent('plan')">Treningsplan</button></td>`;
            }

            //}
            //}
        }

        buttons.innerHTML = `<tr>${buttonsString}</tr>`;

    }

    function displayLifts() {

        if (Object.entries(lifts).length > 0) {

            let keys = Object.keys(lifts);
            list.innerHTML = "<tr>";

            if (keys.length > 0) {

                listTitle.innerText = "Løft:";
                for (let i = 0; i < keys.length; i++) {

                    let liftKeys = lifts[keys[i]];

                    if (liftKeys.ORM !== "0" && liftKeys.ORM !== 0 && liftKeys.ORM !== "") {

                        let msg = `
                        <td>${keys[i]} : ${liftKeys.ORM} kg</td>
                        `;

                        let prDateArr = liftKeys.PRdate.split(".");

                        if (prDateArr.length === 3) {

                            if (prDateArr[0] > 0 && prDateArr[0] <= 31 && prDateArr[0].length <= 2 && prDateArr[1] > 0 && prDateArr[1] <= 12 && prDateArr[1].length <= 2 && prDateArr[2].length === 4) {

                                const d = new Date();

                                const prDate = new Date(prDateArr[2], (prDateArr[1] - 1), prDateArr[0]);

                                function calcTime() {
                                    let daysSinceTime = (d - prDate) / (1000 * 3600 * 24);
                                    return parseInt(daysSinceTime);
                                }

                                msg = `
                                <td>${keys[i]}: ${liftKeys.ORM} kg
                                <br>
                                Dato: ${liftKeys.PRdate}
                                <br>
                                Dager siden: ${calcTime()}</td>`;

                                /*
                                msg = `
                                <td>${keys[i]}: <br> ${liftKeys.ORM} kg</td>
                                
                                <td>Dato: <br>${liftKeys.PRdate}</td>
                                
                                <td>Dager siden: <br>${calcTime()}</td>`;
                                */

                            }

                        }

                        list.innerHTML += msg;
                    }
                }

                list.innerHTML += "</tr>"

                if (lifts.Benkpress && lifts.Knebøy && lifts.Markløft) {

                    let Benkpress = lifts.Benkpress.ORM;
                    let Knebøy = lifts.Knebøy.ORM;
                    let Markløft = lifts.Markløft.ORM;

                    if (Benkpress !== "0" && Benkpress !== 0 && Benkpress !== "") {
                        if (Knebøy !== "0" && Knebøy !== 0 && Knebøy !== "") {
                            if (Markløft !== "0" && Markløft !== 0 && Markløft !== "") {

                                Benkpress = parseFloat(Benkpress);
                                Knebøy = parseFloat(Knebøy);
                                Markløft = parseFloat(Markløft);

                                const totalORM = (Benkpress + Knebøy + Markløft);

                                document.getElementById("showTotalLift").innerHTML = `PR Totalt: <br> ${totalORM.toFixed(2)} KG | ${(totalORM * 2.2).toFixed(2)} LBS`;

                            }
                        }
                    }

                }

            }
        }

    }

    function displayGoals() {

        if (Object.entries(goals).length > 0) {

            let keys = Object.keys(goals);
            list.innerHTML = "<tr>";

            if (keys.length > 0) {
                listTitle.innerText = "Mål:"
                for (let i = 0; i < keys.length; i++) {

                    let liftKeys = goals[keys[i]];

                    if (liftKeys.goal !== "0" && liftKeys.goal !== 0 && liftKeys.goal !== "") {

                        let msg = `<td>${keys[i]}:<br>${liftKeys.goal} kg</td>`;

                        let prDateArr = liftKeys.Goaldate.split(".");

                        if (prDateArr.length === 3) {

                            if (prDateArr[0] > 0 && prDateArr[0] <= 31 && prDateArr[0].length <= 2 && prDateArr[1] > 0 && prDateArr[1] <= 12 && prDateArr[1].length <= 2 && prDateArr[2].length === 4) {

                                const d = new Date();

                                const prDate = new Date(prDateArr[2], (prDateArr[1] - 1), prDateArr[0]);

                                function calcTime() {
                                    let daysSinceTime = (d - prDate) / (1000 * 3600 * 24);
                                    return parseInt(daysSinceTime);
                                }

                                if (liftKeys.goal && lifts[keys[i]]) {

                                    let PRnum = parseFloat(lifts[keys[i]].ORM);
                                    let goalnum = parseFloat(liftKeys.goal);

                                    if (PRnum < goalnum) {
                                        let untilGoalCalcKG = goalnum;

                                        if (PRnum !== 0) {
                                            untilGoalCalcKG = goalnum - PRnum;
                                        }

                                        let untilGoal = `${untilGoalCalcKG} kg`;

                                        msg = `<td>${keys[i]}:<br>${liftKeys.goal} kg<br>Ifra målet:<br>${untilGoal}<br>Dato:<br>${liftKeys.Goaldate}<br>Dager siden: ${calcTime()}</td>`;
                                    } else {
                                        msg = `<td>${keys[i]}:<br>${liftKeys.goal} kg<br>Dato:<br>${liftKeys.Goaldate}<br>Dager siden:<br>${calcTime()}</td>`;
                                    }

                                } else {
                                    msg = `${keys[i]}: ${liftKeys.goal} kg Dato: ${liftKeys.Goaldate} Dager siden: ${calcTime()}<br>`;
                                }
                            }

                        }

                        list.innerHTML += msg;
                    }
                }

                list.innerHTML += "</tr>";

            }
        }

    }

    function displayProgram() {

        if (Object.entries(program).length > 0) {

            let keys = Object.keys(program);
            list.innerHTML = "<tr>";

            if (keys.length > 0) {
                listTitle.innerText = "Treningsplan:"
                for (let i = 0; i < keys.length; i++) {

                    let liftKeys = program[keys[i]];

                    if (liftKeys !== "0" && liftKeys !== 0 && liftKeys !== "") {

                        let msg = `<td>${keys[i]}:<br>${liftKeys}</td>`;

                        list.innerHTML += msg;
                    }
                }

            }

            list.innerHTML += "</tr>";
        }

    }


</script>

</html>