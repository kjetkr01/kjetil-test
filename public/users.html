<!DOCTYPE html>
<html>

<head>
   <title>Brukere</title>

   <meta charset="utf-8" />

   <!-- manifest -->

   <link rel="manifest" href="manifest.json">

   <meta name="mobile-web-app-capable" content="yes">
   <meta name="apple-mobile-web-app-capable" content="yes">
   <meta name="application-name" content="Treningsstatistikken">
   <meta name="apple-mobile-web-app-title" content="Treningsstatistikken">
   <meta name="msapplication-starturl" content="/">
   <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=0">

   <link rel="icon" sizes="192x192" type="image/png" href="images/placeholder_logo_icon.png">
   <link rel="apple-touch-icon" sizes="192x192" type="image/png" href="images/placeholder_logo_icon.png">

   <!-- -->

   <!-- splashscreen for ios -->

   <link href="images/splashscreens/iphone5_splash.png"
      media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)"
      rel="apple-touch-startup-image" />
   <link href="images/splashscreens/iphone6_splash.png"
      media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)"
      rel="apple-touch-startup-image" />
   <link href="images/splashscreens/iphoneplus_splash.png"
      media="(device-width: 621px) and (device-height: 1104px) and (-webkit-device-pixel-ratio: 3)"
      rel="apple-touch-startup-image" />
   <link href="images/splashscreens/iphonex_splash.png"
      media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)"
      rel="apple-touch-startup-image" />
   <link href="images/splashscreens/iphonexr_splash.png"
      media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)"
      rel="apple-touch-startup-image" />
   <link href="images/splashscreens/iphonexsmax_splash.png"
      media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)"
      rel="apple-touch-startup-image" />
   <link href="images/splashscreens/ipad_splash.png"
      media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2)"
      rel="apple-touch-startup-image" />
   <link href="images/splashscreens/ipadpro1_splash.png"
      media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2)"
      rel="apple-touch-startup-image" />
   <link href="images/splashscreens/ipadpro3_splash.png"
      media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2)"
      rel="apple-touch-startup-image" />
   <link href="images/splashscreens/ipadpro2_splash.png"
      media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2)"
      rel="apple-touch-startup-image" />

   <!-- -->

   <!-- status bar color -->

   <meta id="themeColor" name="theme-color" content="#357F9B">
   <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

   <!-- -->

   <link rel="stylesheet" href="styles/global/globalVariables.css">
   <link rel="stylesheet" href="styles/global/globalClasses.css">
   <link rel="stylesheet" href="styles/global/global.css">

   <link rel="stylesheet" href="styles/global/themes.css">

   <link rel="stylesheet" href="styles/shared/exploreDefault.css">

   <link rel="stylesheet" href="styles/shared/overlay.css">

   <link rel="stylesheet" href="styles/users/board.css">

   <script src="sw.js" type="module"></script>

   <script src="ts_application.js" type="text/javascript"></script>
   <script src="scripts/global/appInfo.js" type="text/javascript"></script>
   <script src="scripts/global/user.js" type="text/javascript"></script>
   <script src="scripts/global/global.js" type="text/javascript"></script>
   <script src="scripts/global/functions.js" type="text/javascript"></script>
   <script src="scripts/leaderboards/leaderboards.js" type="text/javascript"></script>
   <script src="scripts/shared/overlay.js" type="text/javascript"></script>

</head>

<body>

   <script>
      useHTTPS();
      createUserClass();
      changeColorTheme();
   </script>

   <div id="TSAlertOverlay" style="display: none;" class="overlay noselect"></div>
   <div id="TSConfirmOverlay" style="display: none;" class="overlay noselect"></div>

   <section id="page">

      <div id="c1r1"></div>
      <div id="c2r1"></div>

      <div id="GbackBtn">
         <svg id="backBtn" class="backBtnIcon fadeInLeft animate delaySmall pointer" style="stroke:white;"
            draggable="false" onclick="redirectToExplore();" xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 22.49 39.22">
            <g id="Layer_2" data-name="Layer 2">
               <g id="Layer_1-2" data-name="Layer 1">
                  <polyline class="cls-1" points="21.25 1.24 2.48 20.02 20.45 37.99" />
               </g>
            </g>
         </svg>
      </div>

      <div id="Gtitle">
         <p id="title" class="noselect">
            Brukere
         </p>
      </div>

      <div id="Ginformation">
         <p id="information" class="noselect">
         </p>
      </div>

      <div id="Gline">
         <hr id="line" class="noselect">
      </div>

      <div id="Glist">
         <div id="list" class="noselect">
            <img class="loadingGif" draggable="false" src="images/loading.gif"></img>
         </div>
      </div>

   </section>

</body>

<script>
   "use strict";

   getTSAlertOverlay();
   getTSConfirmOverlay();

   let allUsers = null, searchFilter = "", prevList = [];;
   const allAPIUsersArr = [];
   function TAllUsers(aAllUsersList) {
      const allUsersList = aAllUsersList;

      this.getList = function () {
         return allUsersList;
      }
   }

   if (user) {

      getUsersList();

      // gets a list of all public users
      async function getUsersList() {

         const information = document.getElementById("information");

         if (navigator.onLine) {

            const cached_usersTxt = sessionStorage.getItem("cached_usersTxt");

            if (cached_usersTxt) {
               information.innerHTML = cached_usersTxt;
            }

            const infoHeader = {};
            const url = `/users/list/all`;

            const resp = await callServerAPIPost(infoHeader, url);

            if (resp.hasOwnProperty("allUsers")) {
               allUsers = new TAllUsers(resp.allUsers);

               const usersKeys = Object.keys(resp.allUsers);

               let totalUsers = usersKeys.length;
               let usersText = "";
               if (user.getDetail("isadmin") === true) {

                  for (let i = 0; i < resp.allAPIUsers.length; i++) {
                     allAPIUsersArr.push(parseInt(resp.allAPIUsers[i].user_id));
                  }

                  usersText = `${application.name} har ${totalUsers} brukere. ${allAPIUsersArr.length} av brukerene har API-tilgang.<br>Du kan trykke deg inn på en bruker for å se mer detaljer.`;
                  if (totalUsers === 0) {
                     usersText = `Det finnes ingen brukere`;
                  }
               } else {

                  usersText = `${application.name} har ${totalUsers} offentlige brukere.<br>Du kan trykke deg inn på en bruker for å se mer detaljer.`;
                  if (totalUsers === 0) {
                     usersText = `Det finnes ingen offentlige brukere`;
                  }
               }

               sessionStorage.setItem("cached_usersTxt", usersText);

               document.getElementById("information").innerHTML = usersText;

               if (totalUsers > 5) {
                  document.getElementById("information").innerHTML += `<br><br><input id="searchUsersInp" class="searchInp" placeholder="Søk" onkeyup="checkSearch();"></input>`;
                  const cached_search_users = sessionStorage.getItem("cached_search_users");
                  if (cached_search_users) {
                     const searchDom = document.getElementById("searchUsersInp");
                     if (searchDom) {
                        searchFilter = cached_search_users;
                        searchDom.value = searchFilter;
                        sessionStorage.removeItem("cached_search_users");
                     }
                  }
               }
            }

            displayAllUsers();

         } else {
            information.innerHTML = `Du må ha Internett-forbindelse for å hente listen med alle offentlige brukere`;
         }
      }
      // End of getUsersList function

   }


   function displayAllUsers() {

      if (allUsers) {

         const allUsersList = allUsers.getList();

         allUsersList.sort(function (a, b) { return a.id - b.id });

         const list = document.getElementById("list");

         let tempList = [];
         if (searchFilter.length > 0) {
            for (let i = 0; i < allUsersList.length; i++) {
               const current = allUsersList[i];
               if (!current.displayname.toLowerCase().includes(searchFilter.toLowerCase()) && !current.username.toLowerCase().includes(searchFilter.toLowerCase())) {
               } else {
                  tempList.push(current);
               }
            }
         } else {
            tempList = allUsersList;
         }

         if (JSON.stringify(tempList) !== JSON.stringify(prevList)) {
            const usersKeys = Object.keys(tempList);
            prevList = tempList;
            list.innerHTML = "";

            if (tempList.length > 0) {
               const isAdmin = user.getDetail("isadmin") === true;

               for (let i = 0; i < usersKeys.length; i++) {

                  const currentUser = tempList[usersKeys[i]];

                  let accountColor = "peopleListName";
                  let visitBtn = `
               <button class="visitBtn pointer" onClick="saveSearch();redirectToUser('${currentUser.id}');">Besøk</button>
               `;
                  if (currentUser.id === user.getId()) {
                     accountColor = "accountOwner";
                     visitBtn = `
               <button class="visitBtn pointer" onClick="redirectToUser('${currentUser.id}');">Din bruker</button>
               `;
                  }

                  let extraDetails = "";

                  if (isAdmin === true) {

                     let visibilityTxt = "";

                     if (currentUser.publicprofile === false) {
                        visibilityTxt = "Privat";
                     }

                     let APIAccessTxt = `<button style="color:green;" class="apibtn pointer" onClick="saveSearch();giveAPIAccessConfirm('${currentUser.username}','${currentUser.id}');">Gi API tilgang</button>`;

                     if (allAPIUsersArr.includes(currentUser.id)) {
                        APIAccessTxt = `<button style="color:red;" class="apibtn pointer" onClick="saveSearch();removeAPIAccessConfirm('${currentUser.username}','${currentUser.id}');">Fjern API tilgang</button>`;
                     }

                     if (currentUser.id === user.getId()) {
                        visibilityTxt = "";
                        APIAccessTxt = "";
                     }

                     extraDetails =
                        `<div id="Gid">
               <div id="id">
                  ID: ${currentUser.id}
               </div>
               </div>

               <div id="Gvisibility">
               <div id="visibility" style="color:red;">
                  ${visibilityTxt}
               </div>
               </div>

               <div id="GAPIaccess">
               <div id="APIaccess">
                  ${APIAccessTxt}
               </div>
               </div>
               `;
                  }

                  list.innerHTML += `
         <div class="users fadeInUp animate">

         <div id="Gdisplayname">
         <div id="displayname" class="${accountColor}">
            ${currentUser.displayname}
         </div>
         </div>

         <div id="Gusername">
         <div id="username" class="${accountColor}">
            ${currentUser.username}
         </div>
         </div>

         ${extraDetails}

         <div id="GVisit">
         <div id="Visit">
            ${visitBtn}
         </div>
         </div>

         </div>
         <hr class="boardLine fadeIn animate delayMedium">
         `;

               }

            } else {
               list.innerHTML = `<div class="noResults">Ingen brukere funnet</div>`;
            }
            scrollToSavedPos();
         }
      }
   }


   // checks search
   function checkSearch() {
      const searchUsersInp = document.getElementById("searchUsersInp").value;
      if (searchFilter !== searchUsersInp) {
         searchFilter = searchUsersInp;
         displayAllUsers();
      }
   }
   // End of checkSearch function

   // Eventlistener to save current scroll
   document.getElementById("Glist").addEventListener("scroll", function (e) {
      const scrollY = document.getElementById("Glist").scrollTop;
      sessionStorage.setItem("@scroll-Users", scrollY);
   });
   // End of eventlistener

   // scrolls to saved pos if saved
   function scrollToSavedPos() {
      const scrollY = sessionStorage.getItem("@scroll-Users");
      if (scrollY) {
         document.getElementById("Glist").scrollTop = scrollY;
      }
   }
   // End of scrollToSavedPos function

   // Saves search
   function saveSearch() {
      const searchUsers = document.getElementById("searchUsersInp");
      if (searchUsers) {
         if (searchUsers.value.length > 0) {
            sessionStorage.setItem("cached_search_users", searchUsers.value);
         }
      }
   }
   // End of saveSearch function


   // giveAPIAccessConfirm
   async function giveAPIAccessConfirm(aUsername, aID) {

      if (aID && aUsername) {
         showConfirm(`Er du sikker på at du ønsker å gi ${aUsername} (${aID}) API tilgang?`, `giveAPIAccess('${aUsername}', '${aID}');`);
      }
   }
   // End of giveAPIAccessConfirm function

   // giveAPIAccess
   async function giveAPIAccess(aUsername, aID) {

      if (aID && aUsername) {

         const giveAPIUsername = aUsername;
         const giveAPIID = parseInt(aID);

         const infoHeader = { "giveAPIUserAccess": giveAPIID };
         const url = `/user/giveAPIAccess`;

         const resp = await callServerAPIPost(infoHeader, url);

         if (resp !== true) {
            showAlert(`Det har oppstått en feil. ${giveAPIUsername} kunne ikke få API-tilgang!`, true);
         }

         location.reload();
      }
   }
   // End of giveAPIAccess function

   // removeAPIAccessConfirm
   async function removeAPIAccessConfirm(aUsername, aID) {

      if (aID && aUsername) {
         showConfirm(`Er du sikker på at du ønsker å fjerne ${aUsername} (${aID}) sin API tilgang?`, `removeAPIAccess('${aUsername}', '${aID}');`);
      }
   }
   // End of removeAPIAccessConfirm function

   // removeAPIAccess
   async function removeAPIAccess(aUsername, aID) {

      if (aID && aUsername) {

         const removeAPIUsername = aUsername;
         const removeAPIID = parseInt(aID);

         const infoHeader = { "removeAPIUserAccess": removeAPIID };
         const url = `/user/removeAPIAccess`;

         const resp = await callServerAPIPost(infoHeader, url);

         if (resp !== true) {
            showAlert(`Det har oppstått en feil. ${removeAPIUsername} kunne ikke fjerne API-tilgang`, true);
         }

         location.reload();
      }
   }
// End of removeAPIAccess function

</script>

</html>