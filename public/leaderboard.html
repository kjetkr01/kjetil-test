<!DOCTYPE html>
<html>

<head>
   <title>Laster...</title>

   <meta charset="utf-8" />

   <!-- manifest -->

   <link rel="manifest" href="manifest.json">

   <meta name="mobile-web-app-capable" content="yes">
   <meta name="apple-mobile-web-app-capable" content="yes">
   <meta name="application-name" content="Treningsstatestikk">
   <meta name="apple-mobile-web-app-title" content="Treningsstatestikk">
   <meta name="msapplication-starturl" content="/">
   <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=0">

   <link rel="icon" type="image/png" sizes="192x192" href="images/appIcon.png">
   <link rel="apple-touch-icon" type="image/png" sizes="192x192" href="images/appIcon.png">

   <!-- -->

   <link rel="stylesheet" href="styles/global.css">
   <link rel="stylesheet" href="styles/leaderboard.css">

   <script src="scripts/global.js" type="text/javascript"></script>
   <script src="scripts/validateInfo.js" type="text/javascript"></script>
   <script src="scripts/script.js" type="text/javascript"></script>

</head>

<body>

   <section id="page">

      <!-- spacing items-->

      <div id="e1r1"></div>
      <div id="e2r1"></div>
      <div id="e3r1"></div>
      <div id="e4r1"></div>

      <!-- -->

      <!-- content items-->

      <div id="c1r1"></div>
      <div id="c2r1"></div>

      <div id="c1r2"></div>
      <div id="c2r2"></div>
      <div id="c3r2"></div>
      <div id="c4r2"></div>
      <div id="c5r2"></div>
      <div id="c6r2"></div>

      <div id="c1r3"></div>
      <div id="c2r3"></div>

      <!-- -->

      <!-- element content items-->

      <!-- header -->

      <div id="Glinks">
         <table id="links">

         </table>
      </div>

      <!-- -->

      <!-- content/middle -->

      <div id="usermsg1G">
         <p id="usermsg1">

         </p>
      </div>

      <div id="listTitleG">
         <p id="listTitle">

         </p>
      </div>

      <div id="listG">
         <table id="list">

         </table>
      </div>

      <div id="backBtnG">
         <p id="backBtn">
            <button class="listButton" onClick="redirectToLeaderboards();">Tilbake</button>
         </p>
      </div>

      <!-- -->

      <!-- footer -->

      <div id="Gfootermenu">
         <p id="footermenu">

         </p>
      </div>

      <!-- -->

   </section>

</body>

<script>

   displayLinks("links");
   checkColorTheme();

   const listTitle = document.getElementById("listTitle");
   const listTitleG = document.getElementById("listTitleG");
   const list = document.getElementById("list");
   const usermsg1 = document.getElementById("usermsg1");

   const ViewingLeaderboard = sessionStorage.getItem("ViewingLeaderboard");

   if (ViewingLeaderboard) {
      document.title = ViewingLeaderboard;
      getListOfLeaderboard();
   } else {
      redirectToLeaderboards();
   }


   async function getListOfLeaderboard() {

      if (token && user) {

         listTitle.innerHTML = loadingText;
         usermsg1.innerHTML = loadingText;

         const body = { "authToken": token, "userInfo": user, "leaderboard": ViewingLeaderboard };
         const url = `/users/list/all/leaderboards/${ViewingLeaderboard}`;

         const resp = await callServerAPI(body, url);

         list.innerHTML = "";

         if (Object.keys(resp).length > 0) {

            listTitle.innerHTML = ViewingLeaderboard;

            listTitleG.innerHTML += `<hr>`;

            // sorts leaderboard in correct order, from highest to lowest
            resp.sort(function (a, b) { return b[ViewingLeaderboard] - a[ViewingLeaderboard] });
            //resp.sort((a, b) => (a[ViewingLeaderboard] < b[ViewingLeaderboard]) ? 1 : -1);

            //

            for (let i = 0; i < Object.keys(resp).length; i++) {

               /*list.innerHTML += `
               <tr>
                  <td>${i + 1}. </td>
                  <td><button class="listButton" onClick="viewUser('${resp[i].username}')">${resp[i].username}</button></td>
                  <td>${resp[i][ViewingLeaderboard]} kg</td>
               </tr>
               `;*/

               list.innerHTML += `
               <tr>
               <td>
               ${i + 1}.
               <br>
               <button class="listButton" onClick="viewUser('${resp[i].username}')">${resp[i].username}</button>
               <br>
               ${resp[i][ViewingLeaderboard]} kg
               </td>
               </tr>
               `;
            }

            if (Object.keys(resp).length === 1) {
               usermsg1.innerHTML = "Det er " + parseInt(Object.keys(resp).length) + " bruker på denne tavlen!";
            } else {
               usermsg1.innerHTML = "Det er " + parseInt(Object.keys(resp).length) + " brukere på denne tavlen!";
            }

         } else {
            usermsg1.innerHTML = errorLoadingText;
            listTitle.innerHTML = errorLoadingText;
            alert(`Ledertavlen ${ViewingLeaderboard} finnes ikke!`);
            window.history.back();
         }

      } else {
         listTitle.innerHTML = "Det er ingen brukere på denne tavlen!";
      }
   }

   //

   function viewUser(viewUser) {

      if (viewUser) {
         sessionStorage.setItem("ViewingUser", viewUser);
         redirectToUser();
      }

   }

</script>

</html>