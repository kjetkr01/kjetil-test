<!DOCTYPE html>
<html>

<head>
   <title>Ledertavler</title>

   <meta charset="utf-8" />

   <!-- manifest -->

   <link rel="manifest" href="manifest.json">

   <meta name="mobile-web-app-capable" content="yes">
   <meta name="apple-mobile-web-app-capable" content="yes">
   <meta name="application-name" content="Treningsstatistikken">
   <meta name="apple-mobile-web-app-title" content="Treningsstatistikken">
   <meta name="msapplication-starturl" content="/">
   <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=0">

   <link rel="icon" type="image/png" sizes="192x192" href="images/appIcon.png">
   <link rel="apple-touch-icon" type="image/png" sizes="192x192" href="images/appIcon.png">

   <!-- -->

   <!-- status bar color -->

   <meta id="themeColor" name="theme-color" content="#357F9B">
   <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

   <!-- -->

   <link rel="stylesheet" href="styles/globalVariables.css">
   <link rel="stylesheet" href="styles/globalClasses.css">
   <link rel="stylesheet" href="styles/global.css">
   <link rel="stylesheet" href="styles/themes/default.css">


   <link rel="stylesheet" href="styles/leaderboards/desktop.css">
   <link rel="stylesheet" href="styles/leaderboards/mobile.css">
   <link rel="stylesheet" href="styles/leaderboards/common.css">

   <link rel="stylesheet" href="styles/leaderboards/board.css">


   <script src="scripts/global.js" type="text/javascript"></script>
   <script src="scripts/leaderboards/leaderboards.js" type="text/javascript"></script>

</head>

<body>

   <section id="page">

      <div id="c1r1"></div>
      <div id="c2r1"></div>
      <div id="c3r1"></div>
      <div id="c4r1"></div>

      <div id="c1r2"></div>
      <div id="c2r2"></div>
      <div id="c3r2"></div>
      <div id="c4r2"></div>
      <div id="c5r2"></div>
      <div id="c6r2"></div>

      <div id="Gtitle">
         <p id="title" class="noselect">
            Ledertavler
         </p>
      </div>

      <div id="GlistOfLeaderboards">
         <table id="listOfLeaderboards" class="noselect">
            <tr id="leaderboardsTableRow">
            </tr>
         </table>
      </div>

      <div id="Gline">
         <hr id="line" class="noselect">
      </div>

      <div id="GpeopleLeaderboardsTxt">
         <p id="peopleLeaderboardsTxt" class="noselect">
            Laster...
         </p>
      </div>

      <div id="GpeopleLeaderboardsList">
         <div id="peopleLeaderboardsList" class="noselect">
         </div>
      </div>

      <div id="Gfeed" class="noselect">
         <img id="feed" onclick="redirectToFeed();" draggable="false" class="icons" src="images/feedIcon.svg"
            alt="Feed">
         </img>
      </div>

      <div id="Gleaderboards" class="noselect">
         <img id="leaderboards" onclick="redirectToLeaderboards();" draggable="false" class="icons"
            src="images/leaderboardsIconActive.svg" alt="Leaderboards">
         </img>
      </div>

      <div id="Gaccount" class="noselect">
         <img id="account" onclick="location.reload();" draggable="false" class="icons" src="images/accountIcon.svg"
            alt="Account">
         </img>
      </div>

   </section>

</body>

<script>

   changeBodyPosition();
   loadLeaderboards();
   async function loadLeaderboards() {

      const body = { "authToken": token, "userInfo": user };
      const url = `/users/list/all/leaderboards`;

      const resp = await callServerAPI(body, url);

      if (resp.length > 0) {

         const leaderboardsTableRowDom = document.getElementById("leaderboardsTableRow");
         leaderboardsTableRowDom.innerHTML = "";

         if (resp[0] === "Benkpress" && resp[1] === "Knebøy" && resp[2] === "Markløft") {

            leaderboardsTableRowDom.innerHTML += `

            <td>
               <button id="Totalt" class="leaderboardsList active fadeInLeft animate delaySmall" onclick="getListOfLeaderboard('Totalt');">Totalt</button>
            </td>

   `;

         }

         for (let i = 0; i < resp.length; i++) {

            leaderboardsTableRowDom.innerHTML += `

            <td>
               <button id="${resp[i]}" class="leaderboardsList fadeInLeft animate" onclick="getListOfLeaderboard('${resp[i]}');">${resp[i]}</button>
            </td>

   `;
         }

      }

   }

   const list = document.getElementById("peopleLeaderboardsList");
   const usermsg1 = document.getElementById("peopleLeaderboardsTxt");

   getListOfLeaderboard();

   let previousLeaderboard = "";
   async function getListOfLeaderboard(aLeaderboard) {

      if (!aLeaderboard) {
         aLeaderboard = "Totalt";
      }

      if (!window.navigator.onLine) {
         return;
      }

      if (token && user && aLeaderboard) {
         const ViewingLeaderboard = aLeaderboard;

         if (document.getElementById(ViewingLeaderboard)) {

            if (document.getElementById(previousLeaderboard)) {
               document.getElementById(previousLeaderboard).classList.remove("active");
            }

            document.getElementById(ViewingLeaderboard).classList.add("active");
         };

         usermsg1.textContent = loadingText;

         list.innerHTML = "";

         const body = { "authToken": token, "userInfo": user, "leaderboard": ViewingLeaderboard };
         const url = `/users/list/all/leaderboards/${ViewingLeaderboard}`;

         const resp = await callServerAPI(body, url);

         list.innerHTML = "";
         previousLeaderboard = ViewingLeaderboard;

         if (Object.keys(resp).length > 0) {

            // sorts leaderboard in correct order, from highest to lowest
            resp.sort(function (a, b) { return b[ViewingLeaderboard] - a[ViewingLeaderboard] });
            //

            for (let i = 0; i < Object.keys(resp).length; i++) {

               let placementHTML = `${i + 1}.`;
               let usernameHTML = `<button class="peopleLeaderboardsListName" onClick="viewUser('${resp[i].username}')">${resp[i].username}</button>`;

               if (resp[i].username === username) {
                  usernameHTML = `<button class="accountOwner" onClick="viewUser('${resp[i].username}')">${resp[i].username}</button>`;
               }

               if (i === 0) {
                  placementHTML = `<img id="placement" draggable="false" class="icons" src="images/goldMedal.svg"
            alt="${i + 1}.">
         </img>`;
               } else if (i === 1) {
                  placementHTML = `<img id="placement" draggable="false" class="icons" src="images/silverMedal.svg"
            alt="${i + 1}.">
         </img>`;
               } else if (i === 2) {
                  placementHTML = `<img id="placement" draggable="false" class="icons" src="images/bronzeMedal.svg"
            alt="${i + 1}.">
         </img>`;
               }

               list.innerHTML += `
               <div class="leaderboard fadeInUp animate">
               <div id="Gplacement">
                  <div id="placement">
                     ${placementHTML}
                  </div>
               </div>
               <div id="Gusername">
                  <div id="username">
                     ${usernameHTML}
                  </div>
               </div>
               <div id="Gweight">
                  <div id="weight">
                     <p>${resp[i][ViewingLeaderboard]} kg</p>
                  </div>
               </div>
            </div>
            <hr class="boardLine fadeIn animate delayMedium">
               `;

            }

            if (Object.keys(resp).length === 1) {
               usermsg1.textContent = "Det er " + parseInt(Object.keys(resp).length) + " bruker på tavlen";
            } else {
               usermsg1.textContent = "Det er " + parseInt(Object.keys(resp).length) + " brukere på tavlen";
            }

         } else {
            usermsg1.textContent = errorLoadingText;
            alert(`Ledertavlen ${ViewingLeaderboard} finnes ikke!`);
            window.history.back();
         }

      } else {
         usermsg1.textContent = "Det er ingen brukere på tavlen";
      }
   }

   //

   setInterval(() => {
      checkConnection("c6r2");
   }, 5000);

   function viewUser(viewUser) {

      if (viewUser) {
         sessionStorage.setItem("ViewingUser", viewUser);
         //redirectToUser();
      }

   }

</script>

</html>